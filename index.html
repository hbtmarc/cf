<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- Primary Meta Tags -->
    <title>Fintech App - Controle Financeiro Pessoal</title>
    <meta name="title" content="Fintech App - Controle Financeiro Pessoal">
    <meta name="description" content="Sistema completo de gest√£o financeira pessoal com dashboards, gr√°ficos, or√ßamentos e relat√≥rios. Controle suas receitas e despesas com seguran√ßa e praticidade.">
    <meta name="keywords" content="finan√ßas pessoais, controle financeiro, or√ßamento, despesas, receitas, fintech">
    <meta name="author" content="Fintech App">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#10b981">
    <meta name="msapplication-TileColor" content="#10b981">
    
    <!-- Favicon (Emoji Data URI) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∏</text></svg>">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∏</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fintech App">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Fintech App - Controle Financeiro Pessoal">
    <meta property="og:description" content="Sistema completo de gest√£o financeira pessoal com dashboards, gr√°ficos, or√ßamentos e relat√≥rios.">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Fintech App - Controle Financeiro Pessoal">
    <meta name="twitter:description" content="Sistema completo de gest√£o financeira pessoal com dashboards, gr√°ficos, or√ßamentos e relat√≥rios.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmludGVjaCBBcHAiLCJzaG9ydF9uYW1lIjoiRmludGVjaCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIiwidGhlbWVfY29sb3IiOiIjMTBiOTgxIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmclMjB4bWxucyUzRCUyMmh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJTIyJTIwdmlld0JveCUzRCUyMjAlMjAwJTIwMTAwJTIwMTAwJTIyJTNFJTNDdGV4dCUyMHklM0QlMjIuOWVtJTIyJTIwZm9udC1zaXplJTNEJTIyOTAlMjIlM0UlRjAlOUYlOTIlQjglM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Tailwind CSS CDN (Development/Prototype) -->
    <!-- Note: For production, install Tailwind via npm: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
        
        @layer base {
            body {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            }
        }
    </style>
    
    <!-- Print Styles -->
    <style media="print">
        @page {
            margin: 1cm;
            size: A4;
        }
        
        body {
            background: white !important;
            color: black !important;
        }
        
        /* Hide elements not needed in print */
        aside,
        header button,
        #btn-new-transaction,
        .filter-btn,
        #btn-export-csv,
        #btn-print-report,
        .print\:hidden {
            display: none !important;
        }
        
        /* Adjust layout for print */
        #view-dashboard {
            display: block !important;
            min-height: auto !important;
        }
        
        header {
            position: static !important;
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 20px;
        }
        
        /* Show full transactions list without scroll */
        #transactions-container {
            max-height: none !important;
            overflow: visible !important;
        }
        
        /* Adjust cards layout */
        .grid {
            page-break-inside: avoid;
        }
        
        /* Ensure charts print */
        canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        
        /* Remove shadows and gradients for cleaner print */
        .shadow-xl,
        .shadow-lg,
        .shadow-md,
        .shadow-sm {
            box-shadow: 0 0 0 1px #e2e8f0 !important;
        }
        
        .bg-gradient-to-r,
        .bg-gradient-to-br,
        .bg-gradient-to-l {
            background: white !important;
            border: 1px solid #e2e8f0 !important;
        }
        
        /* Print header with logo */
        .print-header {
            display: flex !important;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }
        
        /* Page breaks */
        .page-break {
            page-break-after: always;
        }
        
        /* Ensure text is readable */
        .text-white {
            color: #000 !important;
        }
    </style>
</head>
<body class="min-h-screen antialiased bg-slate-50">
    
    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        
        <!-- Loading View -->
        <section id="view-loading" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                <div class="relative w-16 h-16">
                    <div class="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-emerald-500 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <p class="text-slate-700 font-medium">Carregando...</p>
            </div>
        </section>

        <!-- Login/Register View -->
        <section id="view-login" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md">
                <!-- Logo/Brand -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg mb-4">
                        <i class="fas fa-wallet text-white text-2xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800">Finan√ßas Pessoais</h1>
                    <p class="text-slate-600 mt-2">Controle suas finan√ßas com intelig√™ncia</p>
                </div>

                <!-- Login Card -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <!-- Tab Navigation -->
                    <div class="flex space-x-2 mb-6 bg-slate-100 rounded-xl p-1">
                        <button id="tab-login" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 bg-white text-emerald-600 shadow-sm">
                            Entrar
                        </button>
                        <button id="tab-register" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 text-slate-600 hover:text-slate-800">
                            Cadastrar
                        </button>
                    </div>

                    <!-- Login Form -->
                    <form id="form-login" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-envelope mr-2 text-slate-400"></i>E-mail
                            </label>
                            <input 
                                type="email" 
                                id="login-email" 
                                placeholder="seu@email.com"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                required
                            />
                        </div>
                        
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-lock mr-2 text-slate-400"></i>Senha
                            </label>
                            <input 
                                type="password" 
                                id="login-password" 
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                required
                            />
                        </div>

                        <button 
                            type="submit" 
                            class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200"
                        >
                            <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                        </button>
                    </form>

                    <!-- Register Form -->
                    <form id="form-register" class="space-y-4 hidden">
                        <div>
                            <label for="register-name" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-user mr-2 text-slate-400"></i>Nome Completo
                            </label>
                            <input 
                                type="text" 
                                id="register-name" 
                                placeholder="Seu nome"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                required
                            />
                        </div>

                        <div>
                            <label for="register-email" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-envelope mr-2 text-slate-400"></i>E-mail
                            </label>
                            <input 
                                type="email" 
                                id="register-email" 
                                placeholder="seu@email.com"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                required
                            />
                        </div>
                        
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-lock mr-2 text-slate-400"></i>Senha (m√≠n. 6 caracteres)
                            </label>
                            <input 
                                type="password" 
                                id="register-password" 
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                minlength="6"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                required
                            />
                        </div>

                        <button 
                            type="submit" 
                            class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200"
                        >
                            <i class="fas fa-user-plus mr-2"></i>Criar Conta
                        </button>
                    </form>

                    <!-- Alert/Error Message -->
                    <div id="auth-message" class="mt-4 p-3 rounded-lg text-sm hidden">
                        <span id="auth-message-text"></span>
                    </div>
                </div>

                <!-- Footer -->
                <p class="text-center text-slate-500 text-sm mt-6">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Seus dados s√£o protegidos com Firebase Auth
                </p>
            </div>
        </section>

        <!-- Dashboard View -->
        <section id="view-dashboard" class="hidden min-h-screen flex flex-col">
            
            <!-- Print-only Header -->
            <div class="hidden print-header" style="display: none;">
                <div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-wallet" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Relat√≥rio Financeiro</h1>
                            <p style="font-size: 12px; color: #64748b; margin: 0;" id="print-date"></p>
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 14px; font-weight: 600; margin: 0;" id="print-user-name"></p>
                    <p style="font-size: 12px; color: #64748b; margin: 0;" id="print-user-email"></p>
                </div>
            </div>
            
            <!-- Fixed Header -->
            <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <!-- Logo & Title -->
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-wallet text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-slate-800">Dashboard</h1>
                                <p class="text-xs text-slate-500" id="current-date"></p>
                            </div>
                        </div>

                        <!-- User Menu -->
                        <div class="flex items-center space-x-4">
                            <!-- Cards Button -->
                            <button id="btn-view-cards" class="px-4 py-2 text-slate-700 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all font-medium text-sm">
                                <i class="fas fa-credit-card mr-2"></i>Cart√µes
                            </button>
                            
                            <!-- Dashboard Button -->
                            <button id="btn-view-dashboard" class="px-4 py-2 text-slate-700 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all font-medium text-sm">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </button>

                            <!-- User Avatar & Dropdown -->
                            <div class="flex items-center space-x-3 border-l border-slate-200 pl-4">
                                <div class="text-right hidden sm:block">
                                    <p class="text-sm font-medium text-slate-800" id="user-name">Usu√°rio</p>
                                    <p class="text-xs text-slate-500" id="user-email">email@example.com</p>
                                </div>
                                <div class="relative">
                                    <button id="user-menu-button" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-slate-100 transition-all">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-white font-semibold">
                                            <span id="user-avatar">U</span>
                                        </div>
                                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                                    </button>
                                    
                                    <!-- Dropdown Menu -->
                                    <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-200 py-2 z-[60]">
                                        <button id="btn-open-settings" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center space-x-2">
                                            <i class="fas fa-user-cog text-slate-400"></i>
                                            <span>Configura√ß√µes</span>
                                        </button>
                                        <button id="btn-toggle-theme" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center space-x-2">
                                            <i id="theme-icon" class="fas fa-moon text-slate-400"></i>
                                            <span id="theme-text">Tema Escuro</span>
                                        </button>
                                        <hr class="my-2 border-slate-200">
                                        <button id="btn-logout" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2">
                                            <i class="fas fa-sign-out-alt"></i>
                                            <span>Sair</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Month Navigation Bar -->
            <div class="sticky top-16 z-40 bg-white border-b border-slate-200 shadow-sm print:hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex items-center justify-between">
                        <!-- Previous Month Button -->
                        <button id="btn-prev-month" class="p-2 hover:bg-slate-100 rounded-lg transition-all group" title="M√™s Anterior">
                            <i class="fas fa-chevron-left text-slate-600 group-hover:text-emerald-600 transition-colors"></i>
                        </button>

                        <!-- Current Month Display -->
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <h2 id="current-month-display" class="text-xl font-bold text-slate-800">Dezembro 2025</h2>
                                <p class="text-xs text-slate-500">Navegue pelos meses para ver o hist√≥rico</p>
                            </div>
                            
                            <!-- Today Button (hidden if current month) -->
                            <button id="btn-today" class="hidden px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-semibold hover:bg-emerald-200 transition-all">
                                <i class="fas fa-calendar-day mr-1.5"></i>Hoje
                            </button>
                        </div>

                        <!-- Next Month Button -->
                        <button id="btn-next-month" class="p-2 hover:bg-slate-100 rounded-lg transition-all group" title="Pr√≥ximo M√™s">
                            <i class="fas fa-chevron-right text-slate-600 group-hover:text-emerald-600 transition-colors"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-slate-50">
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    
                    <!-- Balance Card - Premium Highlight -->
                    <article class="md:col-span-1 bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 rounded-3xl shadow-2xl p-8 text-white relative overflow-hidden transform transition-all hover:scale-[1.02] duration-300">
                        <!-- Decorative background circles -->
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-white/5 rounded-full blur-3xl"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 id="balance-label" class="text-sm font-semibold uppercase tracking-wider opacity-90">Saldo Total</h3>
                                <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                                    <i class="fas fa-wallet text-lg"></i>
                                </div>
                            </div>
                            <p id="card-balance" class="text-4xl md:text-5xl font-bold mb-2 tracking-tight">R$ 0,00</p>
                            <div class="flex items-center text-sm opacity-90">
                                <div class="w-2 h-2 bg-white rounded-full animate-pulse mr-2"></div>
                                <span>Atualizado agora</span>
                            </div>
                        </div>
                    </article>

                    <!-- Income Card - Clean & Modern -->
                    <article class="bg-white rounded-3xl shadow-xl p-6 border border-slate-100 hover:shadow-2xl transition-all duration-300 hover:border-emerald-200">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Receitas</h3>
                                <p id="card-income" class="text-3xl md:text-4xl font-bold text-slate-800 tracking-tight">R$ 0,00</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-100 to-emerald-50 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-arrow-up text-emerald-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-xs text-slate-500">
                            <span class="inline-flex items-center px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full font-medium">
                                <i class="fas fa-arrow-up text-[10px] mr-1"></i>+0%
                            </span>
                            <span class="ml-2">vs. m√™s anterior</span>
                        </div>
                    </article>

                    <!-- Expense Card - Clean & Modern -->
                    <article class="bg-white rounded-3xl shadow-xl p-6 border border-slate-100 hover:shadow-2xl transition-all duration-300 hover:border-rose-200">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Despesas</h3>
                                <p id="card-expense" class="text-3xl md:text-4xl font-bold text-slate-800 tracking-tight">R$ 0,00</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-rose-100 to-rose-50 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-arrow-down text-rose-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-xs text-slate-500">
                            <span class="inline-flex items-center px-2 py-1 bg-rose-50 text-rose-700 rounded-full font-medium">
                                <i class="fas fa-arrow-down text-[10px] mr-1"></i>+0%
                            </span>
                            <span class="ml-2">vs. m√™s anterior</span>
                        </div>
                    </article>
                </div>

                <!-- Credit Cards Section -->
                <section id="cards-section" class="mb-6">
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-100 to-blue-50 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-credit-card text-blue-600 text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Meus Cart√µes</h3>
                                    <p class="text-xs text-slate-500">Gerenciar cart√µes de cr√©dito</p>
                                </div>
                            </div>
                            <button id="btn-new-card" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all text-sm font-semibold">
                                <i class="fas fa-plus mr-2"></i>Novo Cart√£o
                            </button>
                        </div>
                        
                        <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Cards will be rendered here -->
                            <div class="col-span-full p-8 text-center text-slate-400">
                                <i class="fas fa-credit-card text-4xl mb-2"></i>
                                <p class="text-sm">Nenhum cart√£o cadastrado</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Charts Section -->
                <section id="charts-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                    <!-- Chart 1: Despesas por Categoria -->
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-rose-100 to-rose-50 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-pie text-rose-600 text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Despesas por Categoria</h3>
                                    <p class="text-xs text-slate-500">Top 5 categorias</p>
                                </div>
                            </div>
                        </div>
                        <div class="relative h-64">
                            <canvas id="chart-categories"></canvas>
                        </div>
                        <div id="chart-categories-empty" class="hidden h-64 flex items-center justify-center text-center">
                            <div>
                                <i class="fas fa-chart-pie text-slate-200 text-5xl mb-3"></i>
                                <p class="text-slate-400 text-sm">Adicione despesas para visualizar o gr√°fico</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart 2: Receitas vs Despesas -->
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-emerald-100 to-emerald-50 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-bar text-emerald-600 text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Receitas vs Despesas</h3>
                                    <p class="text-xs text-slate-500">√öltimos 6 meses</p>
                                </div>
                            </div>
                        </div>
                        <div class="relative h-64">
                            <canvas id="chart-flow"></canvas>
                        </div>
                        <div id="chart-flow-empty" class="hidden h-64 flex items-center justify-center text-center">
                            <div>
                                <i class="fas fa-chart-bar text-slate-200 text-5xl mb-3"></i>
                                <p class="text-slate-400 text-sm">Adicione transa√ß√µes para visualizar o gr√°fico</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transactions Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                    
                    <!-- Transactions List -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                            <!-- Header -->
                            <div class="flex items-center justify-between p-6 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                                <div>
                                    <h2 class="text-xl font-bold text-slate-800 mb-1">Transa√ß√µes Recentes</h2>
                                    <p class="text-xs text-slate-500">Hist√≥rico completo de movimenta√ß√µes</p>
                                </div>
                                <button id="btn-new-transaction" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Nova
                                </button>
                            </div>
                            
                            <!-- Actions Bar -->
                            <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-100 flex flex-wrap items-center justify-end gap-2">
                                <!-- Export Buttons -->
                                <div class="flex gap-2 print:hidden">
                                    <button id="btn-export-csv" class="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:border-blue-300 hover:text-blue-600 transition-all" title="Exportar para CSV">
                                        <i class="fas fa-file-download mr-1.5"></i>CSV
                                    </button>
                                    <button id="btn-print-report" class="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:border-purple-300 hover:text-purple-600 transition-all" title="Imprimir Relat√≥rio">
                                        <i class="fas fa-print mr-1.5"></i>Imprimir
                                    </button>
                                </div>
                            </div>

                            <!-- Vertical Stack: Income + Expenses -->
                            <div class="flex flex-col gap-6 p-6">
                                
                                <!-- Income Block (Priority) -->
                                <div class="space-y-3">
                                    <!-- Income Header -->
                                    <div class="flex items-center gap-3 px-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-sm">
                                            <i class="fas fa-arrow-up text-white text-sm"></i>
                                        </div>
                                        <h3 class="text-lg font-bold text-slate-800">Entradas</h3>
                                        <span id="income-count" class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">0</span>
                                    </div>
                                    
                                    <!-- Income List -->
                                    <div class="bg-gradient-to-br from-emerald-50/30 to-transparent rounded-2xl border border-emerald-100/50 overflow-hidden">
                                        <ul id="income-list" class="divide-y divide-emerald-100/50 max-h-96 overflow-y-auto">
                                            <!-- Income transactions will be rendered here -->
                                        </ul>
                                    </div>
                                </div>

                                <!-- Expense Block -->
                                <div class="space-y-3">
                                    <!-- Expense Header -->
                                    <div class="flex items-center gap-3 px-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-rose-500 to-rose-600 rounded-lg flex items-center justify-center shadow-sm">
                                            <i class="fas fa-arrow-down text-white text-sm"></i>
                                        </div>
                                        <h3 class="text-lg font-bold text-slate-800">Sa√≠das</h3>
                                        <span id="expense-count" class="px-2 py-1 bg-rose-100 text-rose-700 text-xs font-bold rounded-full">0</span>
                                    </div>
                                    
                                    <!-- Expense List -->
                                    <div class="bg-gradient-to-br from-rose-50/30 to-transparent rounded-2xl border border-rose-100/50 overflow-hidden">
                                        <ul id="expense-list" class="divide-y divide-rose-100/50 max-h-96 overflow-y-auto">
                                            <!-- Expense transactions will be rendered here -->
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Sidebar: Quick Actions & Categories -->
                    <aside class="space-y-4 md:space-y-6">
                        
                        <!-- Quick Add Widget -->
                        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 hover:shadow-2xl transition-all duration-300">
                            <div class="flex items-center mb-5">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                    <i class="fas fa-bolt text-white text-lg"></i>
                                </div>
                                <h3 class="text-lg font-bold text-slate-800">A√ß√£o R√°pida</h3>
                            </div>
                            <div class="space-y-3">
                                <button id="btn-quick-income" class="group w-full px-5 py-4 bg-gradient-to-r from-emerald-50 to-emerald-100/50 border border-emerald-200 text-emerald-700 rounded-2xl hover:from-emerald-100 hover:to-emerald-200 transition-all text-left font-semibold shadow-sm hover:shadow-md flex items-center">
                                    <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform">
                                        <i class="fas fa-arrow-up text-white"></i>
                                    </div>
                                    <span>Adicionar Receita</span>
                                </button>
                                <button id="btn-quick-expense" class="group w-full px-5 py-4 bg-gradient-to-r from-rose-50 to-rose-100/50 border border-rose-200 text-rose-700 rounded-2xl hover:from-rose-100 hover:to-rose-200 transition-all text-left font-semibold shadow-sm hover:shadow-md flex items-center">
                                    <div class="w-10 h-10 bg-rose-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform">
                                        <i class="fas fa-arrow-down text-white"></i>
                                    </div>
                                    <span>Adicionar Despesa</span>
                                </button>
                            </div>
                        </div>

                        <!-- Credit Audit Widget (FASE 12.6) -->
                        <div id="credit-audit-widget" class="bg-white rounded-3xl shadow-xl border border-blue-100 p-6 hover:shadow-2xl transition-all duration-300">
                            <div class="flex items-center mb-5">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                    <i class="fas fa-credit-card text-white text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-slate-800">Compras no Cr√©dito</h3>
                                    <p class="text-xs text-slate-500 mt-0.5">Realizadas este m√™s</p>
                                </div>
                            </div>
                            <div id="credit-purchases-list" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Will be populated by renderCreditAuditWidget() -->
                            </div>
                            <div id="credit-purchases-empty" class="hidden py-8 text-center">
                                <i class="fas fa-shopping-bag text-slate-300 text-3xl mb-2"></i>
                                <p class="text-sm text-slate-400">Nenhuma compra no cr√©dito este m√™s</p>
                            </div>
                        </div>

                    </aside>

                </div>

            </main>

        </section>

        <!-- Transaction Modal -->
        <div id="modal-transaction" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-800">
                        <i class="fas fa-plus-circle mr-2 text-emerald-500"></i>
                        <span id="modal-title">Nova Transa√ß√£o</span>
                    </h2>
                    <button id="btn-close-modal" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Transaction Form -->
                <form id="form-transaction" class="space-y-4">
                    
                    <!-- Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="type" value="receita" class="peer sr-only" required checked />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50">
                                    <i class="fas fa-arrow-up text-green-500 text-xl mb-1"></i>
                                    <p class="text-sm font-medium text-slate-700">Receita</p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="type" value="despesa" class="peer sr-only" required />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-red-500 peer-checked:bg-red-50">
                                    <i class="fas fa-arrow-down text-red-500 text-xl mb-1"></i>
                                    <p class="text-sm font-medium text-slate-700">Despesa</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="txn-description" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-align-left mr-1 text-slate-400"></i>Descri√ß√£o
                        </label>
                        <input 
                            type="text" 
                            id="txn-description" 
                            placeholder="Ex: Sal√°rio, Aluguel, Supermercado..."
                            maxlength="200"
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Value -->
                    <div>
                        <label for="txn-value" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-dollar-sign mr-1 text-slate-400"></i>Valor (R$)
                        </label>
                        <input 
                            type="number" 
                            id="txn-value" 
                            placeholder="0,00"
                            min="0.01"
                            step="0.01"
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="txn-category" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-tag mr-1 text-slate-400"></i>Categoria
                        </label>
                        <select 
                            id="txn-category" 
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                            <option value="">Selecione...</option>
                            <option value="salary">üí∞ Sal√°rio</option>
                            <option value="food">üçî Alimenta√ß√£o</option>
                            <option value="transport">üöó Transporte</option>
                            <option value="utilities">üì± Contas</option>
                            <option value="health">üè• Sa√∫de</option>
                            <option value="entertainment">üéÆ Lazer</option>
                            <option value="education">üìö Educa√ß√£o</option>
                            <option value="shopping">üõçÔ∏è Compras</option>
                            <option value="investments">üìà Investimentos</option>
                            <option value="other">üì¶ Outros</option>
                        </select>
                    </div>

                    <!-- Date -->
                    <div>
                        <label for="txn-date" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-calendar mr-1 text-slate-400"></i>Data
                        </label>
                        <input 
                            type="date" 
                            id="txn-date" 
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Payment Method -->
                    <div>
                        <label for="txn-payment-method" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-wallet mr-1 text-slate-400"></i>Forma de Pagamento
                        </label>
                        <select 
                            id="txn-payment-method" 
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                            <option value="cash">üíµ Dinheiro / D√©bito / Pix</option>
                            <option value="credit">üí≥ Cart√£o de Cr√©dito</option>
                        </select>
                    </div>

                    <!-- Credit Card Options (Conditional) -->
                    <div id="credit-card-options" class="hidden space-y-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <!-- Card Selection -->
                        <div>
                            <label for="txn-card" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-credit-card mr-1 text-slate-400"></i>Selecione o Cart√£o
                            </label>
                            <select 
                                id="txn-card" 
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white"
                            >
                                <option value="">Selecione um cart√£o...</option>
                                <!-- Cards will be populated dynamically -->
                            </select>
                        </div>

                        <!-- Installments -->
                        <div>
                            <label for="txn-installments" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-list-ol mr-1 text-slate-400"></i>Parcelas
                            </label>
                            <div class="flex items-center gap-3">
                                <input 
                                    type="number" 
                                    id="txn-installments"
                                    min="1"
                                    max="24"
                                    value="1"
                                    class="w-24 px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white"
                                />
                                <span class="text-sm text-slate-600">x</span>
                                <span id="installment-value" class="text-lg font-bold text-blue-600">R$ 0,00</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>Cada parcela no valor acima
                            </p>
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label for="txn-status" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-check-circle mr-1 text-slate-400"></i>Status
                        </label>
                        <select 
                            id="txn-status" 
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                            <option value="confirmada">‚úÖ Confirmada</option>
                            <option value="pendente">‚è≥ Pendente</option>
                        </select>
                    </div>

                    <!-- Recurrence Section -->
                    <div class="border-t border-slate-200 pt-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="txn-recurring"
                                class="w-5 h-5 text-emerald-500 border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 transition-all cursor-pointer"
                            />
                            <span class="text-sm font-medium text-slate-700">
                                <i class="fas fa-sync-alt mr-1 text-slate-400"></i>Repetir Transa√ß√£o?
                            </span>
                        </label>
                        
                        <div id="recurring-options" class="hidden mt-4 space-y-3 pl-8 border-l-2 border-emerald-200">
                            <div>
                                <label for="txn-recurring-months" class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-1 text-slate-400"></i>Repetir por:
                                </label>
                                <div class="flex items-center gap-2">
                                    <input 
                                        type="number" 
                                        id="txn-recurring-months"
                                        min="2"
                                        max="120"
                                        value="12"
                                        class="w-24 px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                                    />
                                    <span class="text-sm text-slate-600">meses</span>
                                </div>
                                <p id="recurring-info" class="text-xs text-slate-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>Ser√£o criadas transa√ß√µes at√© <span id="recurring-end-date" class="font-semibold">‚Äî</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="modal-message" class="hidden p-3 rounded-lg text-sm">
                        <span id="modal-message-text"></span>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2">
                        <button 
                            type="button" 
                            id="btn-cancel-transaction"
                            class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-all"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            class="flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                        >
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Category Modal -->
        <div id="modal-category" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-800">
                        <i class="fas fa-folder-plus mr-2 text-emerald-500"></i>
                        Nova Categoria Pessoal
                    </h2>
                    <button id="btn-close-category-modal" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Category Form -->
                <form id="form-category" class="space-y-4">
                    
                    <!-- Category Name -->
                    <div>
                        <label for="cat-name" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-tag mr-2 text-slate-400"></i>Nome da Categoria
                        </label>
                        <input 
                            type="text" 
                            id="cat-name" 
                            placeholder="Ex: Freelance, Investimentos..."
                            maxlength="50"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Icon Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-icons mr-2 text-slate-400"></i>√çcone (Emoji)
                        </label>
                        <div class="grid grid-cols-8 gap-2">
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üí∞">üí∞</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üìà">üìà</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üíº">üíº</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üéØ">üéØ</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üèÜ">üèÜ</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üéÅ">üéÅ</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üõí">üõí</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üè†">üè†</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üöó">üöó</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="‚úàÔ∏è">‚úàÔ∏è</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üìö">üìö</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üéÆ">üéÆ</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üíä">üíä</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üèãÔ∏è">üèãÔ∏è</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üé¨">üé¨</button>
                            <button type="button" class="icon-selector p-2 text-2xl hover:bg-slate-100 rounded-lg transition-all" data-icon="üçî">üçî</button>
                        </div>
                        <input type="hidden" id="cat-icon" value="üìÅ" />
                        <p class="text-xs text-slate-500 mt-2">Selecionado: <span id="selected-icon" class="text-2xl">üìÅ</span></p>
                    </div>

                    <!-- Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="cat-type" value="receita" class="peer sr-only" required />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50">
                                    <i class="fas fa-arrow-up text-green-500 text-xl mb-1"></i>
                                    <p class="text-sm font-medium text-slate-700">Receita</p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="cat-type" value="despesa" class="peer sr-only" required checked />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-red-500 peer-checked:bg-red-50">
                                    <i class="fas fa-arrow-down text-red-500 text-xl mb-1"></i>
                                    <p class="text-sm font-medium text-slate-700">Despesa</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="category-modal-message" class="hidden p-3 rounded-lg text-sm">
                        <span id="category-modal-message-text"></span>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2">
                        <button 
                            type="button" 
                            id="btn-cancel-category"
                            class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-all"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            class="flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                        >
                            <i class="fas fa-save mr-2"></i>Criar
                        </button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Budget Modal -->
        <div id="modal-budget" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b">
                    <h2 class="text-xl font-bold text-slate-800">
                        <i class="fas fa-bullseye mr-2 text-purple-500"></i>
                        Definir Metas de Gastos
                    </h2>
                    <button id="btn-close-budget-modal" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <p class="text-sm text-slate-600 mb-6">
                    Configure o limite mensal de gastos para cada categoria. Voc√™ ser√° alertado quando atingir 75% da meta.
                </p>

                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input 
                            type="text" 
                            id="budget-search" 
                            placeholder="Buscar categoria..."
                            class="w-full pl-11 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all"
                        />
                    </div>
                </div>

                <!-- Budget List -->
                <div id="budget-list" class="space-y-3 max-h-[400px] overflow-y-auto">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Actions -->
                <div class="flex gap-3 pt-6 mt-6 border-t sticky bottom-0 bg-white">
                    <button 
                        type="button" 
                        id="btn-cancel-budget"
                        class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-all"
                    >
                        Cancelar
                    </button>
                    <button 
                        id="btn-save-budgets"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                    >
                        <i class="fas fa-save mr-2"></i>Salvar Metas
                    </button>
                </div>
            </div>
        </div>

        <!-- Card Modal -->
        <div id="modal-card" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-800">
                        <i class="fas fa-credit-card mr-2 text-blue-500"></i>
                        <span id="card-modal-title">Novo Cart√£o de Cr√©dito</span>
                    </h2>
                    <button id="btn-close-card-modal" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Card Form -->
                <form id="form-card" class="space-y-5">
                    
                    <!-- Card Name -->
                    <div>
                        <label for="card-name" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-signature mr-1 text-slate-400"></i>Nome do Cart√£o
                        </label>
                        <input 
                            type="text" 
                            id="card-name" 
                            placeholder="Ex: Nubank, Inter, C6 Bank..."
                            maxlength="30"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Limit -->
                    <div>
                        <label for="card-limit" class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-dollar-sign mr-1 text-slate-400"></i>Limite Total
                        </label>
                        <input 
                            type="number" 
                            id="card-limit" 
                            placeholder="0,00"
                            step="0.01"
                            min="0"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        />
                    </div>

                    <!-- Closing and Due Days -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="card-closing-day" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-calendar-check mr-1 text-slate-400"></i>Dia Fechamento
                            </label>
                            <input 
                                type="number" 
                                id="card-closing-day" 
                                placeholder="15"
                                min="1"
                                max="31"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-center font-semibold"
                                required
                            />
                            <p class="text-xs text-slate-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>Melhor dia para comprar: dia seguinte
                            </p>
                        </div>
                        <div>
                            <label for="card-due-day" class="block text-sm font-medium text-slate-700 mb-2">
                                <i class="fas fa-calendar-times mr-1 text-slate-400"></i>Dia Vencimento
                            </label>
                            <input 
                                type="number" 
                                id="card-due-day" 
                                placeholder="25"
                                min="1"
                                max="31"
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-center font-semibold"
                                required
                            />
                        </div>
                    </div>

                    <!-- Color Selector (Bank Presets) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">
                            <i class="fas fa-palette mr-1 text-slate-400"></i>Cor do Cart√£o (Escolha seu banco)
                        </label>
                        <div class="grid grid-cols-4 gap-3">
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#820AD1" data-name="Nubank" style="background: #820AD1;" title="Roxo Nubank">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Nu</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#FF7A00" data-name="Inter" style="background: #FF7A00;" title="Laranja Inter">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Inter</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#EC0000" data-name="Santander" style="background: #EC0000;" title="Vermelho Santander">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Sant</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#004DCF" data-name="Ita√∫" style="background: #004DCF;" title="Azul Ita√∫">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Ita√∫</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#111111" data-name="Black" style="background: #111111;" title="Preto Carbon">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Black</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#00C65E" data-name="C6" style="background: #00C65E;" title="Verde C6">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">C6</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#F4C20D" data-name="Banco do Brasil" style="background: #F4C20D;" title="Amarelo BB">
                                <span class="absolute inset-0 flex items-center justify-center text-slate-700 text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">BB</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                            <button type="button" class="color-selector group relative w-full aspect-square rounded-xl transition-all hover:scale-110" data-color="#6B7280" data-name="Cinza" style="background: #6B7280;" title="Cinza Padr√£o">
                                <span class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">Outro</span>
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full hidden items-center justify-center ring-2 ring-blue-500">
                                    <i class="fas fa-check text-blue-500 text-xs"></i>
                                </div>
                            </button>
                        </div>
                        <input type="hidden" id="card-color" value="#820AD1" />
                    </div>

                    <!-- Brand -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i class="fas fa-building-columns mr-1 text-slate-400"></i>Bandeira
                        </label>
                        <div class="grid grid-cols-3 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="card-brand" value="mastercard" class="peer sr-only" checked />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50">
                                    <i class="fab fa-cc-mastercard text-3xl text-slate-600 mb-1"></i>
                                    <p class="text-xs font-medium text-slate-700">Mastercard</p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="card-brand" value="visa" class="peer sr-only" />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50">
                                    <i class="fab fa-cc-visa text-3xl text-slate-600 mb-1"></i>
                                    <p class="text-xs font-medium text-slate-700">Visa</p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="card-brand" value="elo" class="peer sr-only" />
                                <div class="p-3 border-2 border-slate-200 rounded-xl text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50">
                                    <i class="fas fa-credit-card text-3xl text-slate-600 mb-1"></i>
                                    <p class="text-xs font-medium text-slate-700">Elo</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="card-modal-message" class="hidden p-3 rounded-lg text-sm">
                        <span id="card-modal-message-text"></span>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2">
                        <button 
                            type="button" 
                            id="btn-cancel-card"
                            class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-all"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                        >
                            <i class="fas fa-save mr-2"></i>Salvar Cart√£o
                        </button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal (FASE 13) -->
        <div id="modal-delete-confirm" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-auto transform transition-all">
                <!-- Header -->
                <div class="px-6 pt-6 pb-4 border-b border-slate-200">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-slate-800">Confirmar Exclus√£o</h3>
                            <p class="text-xs text-slate-500 mt-0.5">Esta a√ß√£o n√£o pode ser desfeita</p>
                        </div>
                        <button 
                            id="btn-close-delete-modal"
                            class="w-8 h-8 rounded-lg hover:bg-slate-100 transition-all flex items-center justify-center"
                        >
                            <i class="fas fa-times text-slate-400"></i>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="px-6 py-6">
                    <!-- Transaction Info -->
                    <div id="delete-transaction-info" class="mb-5 p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p id="delete-txn-description" class="text-sm font-semibold text-slate-800 mb-1"></p>
                                <p id="delete-txn-meta" class="text-xs text-slate-500"></p>
                            </div>
                            <p id="delete-txn-value" class="text-lg font-bold text-rose-600 ml-4"></p>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="delete-message-single" class="hidden mb-4">
                        <p class="text-sm text-slate-600">
                            <i class="fas fa-exclamation-circle text-amber-500 mr-2"></i>
                            Deseja excluir esta transa√ß√£o permanentemente?
                        </p>
                    </div>

                    <div id="delete-message-recurring" class="hidden mb-4">
                        <p class="text-sm font-semibold text-slate-800 mb-2">
                            <i class="fas fa-repeat text-blue-500 mr-2"></i>
                            Esta √© uma transa√ß√£o recorrente/parcelada
                        </p>
                        <p class="text-sm text-slate-600">
                            O que deseja fazer?
                        </p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="px-6 pb-6">
                    <!-- Single Transaction Actions -->
                    <div id="delete-actions-single" class="hidden flex gap-3">
                        <button 
                            id="btn-cancel-delete"
                            class="flex-1 px-4 py-3 border-2 border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all"
                        >
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button 
                            id="btn-delete-single-confirm"
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all"
                        >
                            <i class="fas fa-trash-alt mr-2"></i>Excluir
                        </button>
                    </div>

                    <!-- Recurring Transaction Actions -->
                    <div id="delete-actions-recurring" class="hidden space-y-3">
                        <button 
                            id="btn-delete-this-only"
                            class="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all text-left flex items-center"
                        >
                            <i class="fas fa-file text-lg mr-3 w-5"></i>
                            <div class="flex-1">
                                <p class="font-bold">Excluir Apenas Esta</p>
                                <p class="text-xs opacity-90">Mant√©m as demais parcelas/recorr√™ncias</p>
                            </div>
                        </button>
                        <button 
                            id="btn-delete-this-and-future"
                            class="w-full px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-xl hover:shadow-lg transition-all text-left flex items-center"
                        >
                            <i class="fas fa-files text-lg mr-3 w-5"></i>
                            <div class="flex-1">
                                <p class="font-bold">Excluir Esta e Futuras</p>
                                <p class="text-xs opacity-90">Remove todas as parcelas a partir desta</p>
                            </div>
                        </button>
                        <button 
                            id="btn-cancel-delete-recurring"
                            class="w-full px-4 py-3 border-2 border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all"
                        >
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FASE 19: Settings Modal -->
        <div id="modal-settings" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full mx-auto transform transition-all my-8">
                <!-- Header -->
                <div class="px-6 pt-6 pb-4 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                                <i class="fas fa-cog text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800">Configura√ß√µes</h3>
                                <p class="text-xs text-slate-500 mt-0.5">Gerencie suas prefer√™ncias e dados</p>
                            </div>
                        </div>
                        <button 
                            id="btn-close-settings"
                            class="w-10 h-10 rounded-xl hover:bg-slate-100 transition-all flex items-center justify-center"
                        >
                            <i class="fas fa-times text-slate-400 text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-6 pt-4">
                    <div class="flex gap-2 border-b border-slate-200">
                        <button 
                            id="tab-profile"
                            class="settings-tab px-4 py-2 font-semibold text-sm border-b-2 border-blue-600 text-blue-600 transition-all"
                            data-tab="profile"
                        >
                            <i class="fas fa-user mr-2"></i>Perfil
                        </button>
                        <button 
                            id="tab-data"
                            class="settings-tab px-4 py-2 font-semibold text-sm border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-all"
                            data-tab="data"
                        >
                            <i class="fas fa-database mr-2"></i>Dados & Seguran√ßa
                        </button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="px-6 py-6 max-h-[60vh] overflow-y-auto">
                    
                    <!-- Profile Tab -->
                    <div id="content-profile" class="settings-content">
                        <div class="space-y-6">
                            <!-- Display Name -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    <i class="fas fa-id-card mr-2 text-slate-400"></i>Nome de Exibi√ß√£o
                                </label>
                                <input 
                                    type="text" 
                                    id="settings-display-name"
                                    class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-800"
                                    placeholder="Seu nome"
                                />
                                <button 
                                    id="btn-save-display-name"
                                    class="mt-3 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-lg hover:shadow-lg transition-all text-sm"
                                >
                                    <i class="fas fa-save mr-2"></i>Salvar Nome
                                </button>
                            </div>

                            <!-- Email (Read-only) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    <i class="fas fa-envelope mr-2 text-slate-400"></i>Email
                                </label>
                                <input 
                                    type="email" 
                                    id="settings-email"
                                    class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-xl text-slate-500 cursor-not-allowed"
                                    disabled
                                />
                                <p class="mt-1 text-xs text-slate-500">
                                    <i class="fas fa-info-circle mr-1"></i>O email n√£o pode ser alterado
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Data & Security Tab -->
                    <div id="content-data" class="settings-content hidden">
                        <div class="space-y-8">
                            
                            <!-- Backup Section -->
                            <div class="p-6 bg-blue-50 border-2 border-blue-200 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-800 flex items-center">
                                            <i class="fas fa-cloud-upload-alt text-blue-600 mr-2"></i>
                                            Backup de Dados
                                        </h4>
                                        <p class="text-xs text-slate-600 mt-1">
                                            Proteja suas informa√ß√µes criando c√≥pias de seguran√ßa
                                        </p>
                                    </div>
                                    <button 
                                        id="btn-create-backup"
                                        class="px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all text-sm whitespace-nowrap"
                                    >
                                        <i class="fas fa-save mr-2"></i>Criar Backup
                                    </button>
                                </div>

                                <!-- Backup List -->
                                <div id="backup-list" class="mt-4 space-y-2 max-h-64 overflow-y-auto">
                                    <!-- Will be populated dynamically -->
                                    <div class="text-center py-8 text-slate-500 text-sm">
                                        <i class="fas fa-folder-open text-3xl mb-2 opacity-50"></i>
                                        <p>Nenhum backup dispon√≠vel</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Danger Zone -->
                            <div class="p-6 bg-red-50 border-2 border-red-200 rounded-2xl">
                                <div class="flex items-start">
                                    <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mr-3 flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-lg font-bold text-red-800 mb-2">Zona de Perigo</h4>
                                        <p class="text-sm text-slate-700 mb-4">
                                            A√ß√µes irrevers√≠veis. Um backup autom√°tico ser√° criado antes de qualquer opera√ß√£o.
                                        </p>
                                        <button 
                                            id="btn-reset-all"
                                            class="px-4 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-xl hover:shadow-lg transition-all text-sm"
                                        >
                                            <i class="fas fa-trash-restore mr-2"></i>‚ö†Ô∏è Resetar Todos os Dados
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Cards Management View -->
        <section id="view-cards" class="hidden min-h-screen flex flex-col">
            
            <!-- Fixed Header -->
            <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <!-- Logo & Title -->
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-credit-card text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-slate-800">Meus Cart√µes</h1>
                                <p class="text-xs text-slate-500">Gest√£o de cart√µes de cr√©dito</p>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center space-x-3">
                            <button id="btn-dashboard-from-cards" class="px-4 py-2 text-slate-700 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all font-medium text-sm">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </button>
                            <button id="btn-add-card" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all font-semibold text-sm">
                                <i class="fas fa-plus mr-2"></i>Novo Cart√£o
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- FASE 14.7: Temporal Navigation Bar -->
            <div class="bg-white border-b border-slate-200 sticky top-16 z-30 shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between py-4">
                        <!-- Previous Month -->
                        <button id="btn-prev-card-month" class="px-4 py-2 hover:bg-slate-100 rounded-lg transition-all flex items-center gap-2 text-slate-700 font-medium">
                            <i class="fas fa-chevron-left"></i>
                            <span class="hidden sm:inline">Anterior</span>
                        </button>
                        
                        <!-- Current Period Display -->
                        <div class="text-center">
                            <h2 id="card-period-display" class="text-xl font-bold text-slate-800">Janeiro 2026</h2>
                            <p class="text-xs text-slate-500">Per√≠odo das Faturas</p>
                        </div>
                        
                        <!-- Next Month -->
                        <button id="btn-next-card-month" class="px-4 py-2 hover:bg-slate-100 rounded-lg transition-all flex items-center gap-2 text-slate-700 font-medium">
                            <span class="hidden sm:inline">Pr√≥ximo</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Reset to Current Month Button (conditionally visible) -->
                    <div class="pb-3">
                        <button id="btn-reset-card-month" class="hidden w-full px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition-all font-medium text-sm">
                            <i class="fas fa-calendar-day mr-2"></i>Voltar para Fatura Atual
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content - Master-Detail Layout -->
            <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-slate-50">
                
                <!-- Empty State -->
                <div id="cards-empty-state" class="hidden">
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-16 text-center">
                        <div class="w-24 h-24 bg-gradient-to-br from-blue-100 to-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-credit-card text-blue-500 text-4xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-3">Nenhum cart√£o cadastrado</h3>
                        <p class="text-slate-500 mb-6 max-w-md mx-auto">
                            Adicione seus cart√µes de cr√©dito para ter controle total sobre seus gastos e limites dispon√≠veis.
                        </p>
                        <button id="btn-add-card-empty" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all font-semibold">
                            <i class="fas fa-plus mr-2"></i>Adicionar Primeiro Cart√£o
                        </button>
                    </div>
                </div>

                <!-- Master-Detail Grid (FASE 14) -->
                <div id="cards-master-detail" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- LEFT: Card Selector (Master) -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-xl p-6 sticky top-24">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">
                                <i class="fas fa-credit-card mr-2 text-blue-600"></i>Cart√µes
                            </h2>
                            <div id="cards-selector-list" class="space-y-3">
                                <!-- Card selector buttons will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Invoice Details (Detail) -->
                    <div class="lg:col-span-2">
                        <div class="space-y-6">
                            
                            <!-- Invoice Summary Panel -->
                            <div id="invoice-summary-panel" class="bg-white rounded-2xl shadow-xl p-6">
                                <!-- Will be populated dynamically -->
                            </div>

                            <!-- Invoice Transactions List -->
                            <div id="invoice-transactions-panel" class="bg-white rounded-2xl shadow-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-slate-800">
                                        <i class="fas fa-shopping-cart mr-2 text-blue-600"></i>Compras desta Fatura
                                    </h3>
                                    <div id="invoice-add-button-header">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                                <div id="invoice-transactions-list">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

            </main>
        </section>

    </div>

    <!-- Firebase SDK v10 (Modular) -->
    <script type="module">
        // ============================================
        // FIREBASE CONFIGURATION & INITIALIZATION
        // ============================================
        
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            push,
            update,
            remove,
            onValue,
            query,
            orderByChild,
            equalTo
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyAfrymePnarYrK6csdFshSXQomIz2_YaKo",
            authDomain: "cfmarc35.firebaseapp.com",
            databaseURL: "https://cfmarc35-default-rtdb.firebaseio.com/",
            projectId: "cfmarc35",
            storageBucket: "cfmarc35.firebasestorage.app",
            messagingSenderId: "686702459926",
            appId: "1:686702459926:web:ef022de4df210ea3354937",
            measurementId: "G-ZW17TJ0F5M"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // ============================================
        // PRODUCTION MODE (set to true to disable debug logs)
        // ============================================
        
        const PRODUCTION_MODE = true;
        
        // Debug logger (only logs in development mode)
        const logger = {
            log: (...args) => !PRODUCTION_MODE && console.log(...args),
            warn: (...args) => !PRODUCTION_MODE && console.warn(...args),
            error: (...args) => console.error(...args) // Always log errors
        };

        // ============================================
        // CHARTS INSTANCES (for lifecycle management)
        // ============================================
        
        let categoryChartInstance = null;
        let flowChartInstance = null;

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        const state = {
            user: null,
            currentView: 'login',
            transactions: [],
            categories: {
                global: {},
                personal: {}
            },
            loading: false,
            filters: {
                type: 'all',        // 'all', 'receita', 'despesa'
                sort: 'date_desc',   // 'date_desc', 'date_asc', 'amount_desc', 'amount_asc'
                category: null      // null = all, or categoryId to filter
            },
            editingTransaction: null,  // Holds transaction being edited
            budgets: {},  // { categoryId: monthlyLimit }
            currentDate: new Date(),  // Current month/year being viewed (Dashboard)
            cardDate: new Date(),  // FASE 14.7: Current month/year for Cards view (independent navigation)
            cards: [],  // Array of credit cards
            editingCard: null,  // Holds card being edited
            invoices: {},  // { cardId_monthYear: { status: 'paid', paidAt, amount, transactionId } }
            selectedInvoice: {  // Current invoice being viewed
                cardId: null,
                month: new Date().getMonth(),
                year: new Date().getFullYear()
            },
            backups: {},  // FASE 19: User backups { backupId: { createdAt, type, itemCount } }
            currentTheme: 'light'  // FASE 19: Theme preference
        };

        // Store unsubscribe functions for cleanup
        const listeners = {
            transactions: null,
            categories: null,
            budgets: null,
            cards: null,
            invoices: null,
            backups: null  // FASE 19: Backup listener
        };

        // ============================================
        // UI CONTROLLER
        // ============================================
        
        const ui = {
            elements: {
                // Views
                viewLogin: document.getElementById('view-login'),
                viewDashboard: document.getElementById('view-dashboard'),
                viewLoading: document.getElementById('view-loading'),
                viewCards: document.getElementById('view-cards'),
                
                // Auth forms
                formLogin: document.getElementById('form-login'),
                formRegister: document.getElementById('form-register'),
                tabLogin: document.getElementById('tab-login'),
                tabRegister: document.getElementById('tab-register'),
                authMessage: document.getElementById('auth-message'),
                authMessageText: document.getElementById('auth-message-text'),
                
                // Dashboard elements
                userName: document.getElementById('user-name'),
                userEmail: document.getElementById('user-email'),
                userAvatar: document.getElementById('user-avatar'),
                currentDate: document.getElementById('current-date'),
                btnLogout: document.getElementById('btn-logout'),
                userMenuButton: document.getElementById('user-menu-button'),
                userMenuDropdown: document.getElementById('user-menu-dropdown'),
                
                // Month navigation
                btnPrevMonth: document.getElementById('btn-prev-month'),
                btnNextMonth: document.getElementById('btn-next-month'),
                btnToday: document.getElementById('btn-today'),
                currentMonthDisplay: document.getElementById('current-month-display'),
                
                // Dashboard cards
                cardBalance: document.getElementById('card-balance'),
                cardIncome: document.getElementById('card-income'),
                cardExpense: document.getElementById('card-expense'),
                balanceLabel: document.getElementById('balance-label'),
                
                // Transactions
                transactionsContainer: document.getElementById('transactions-container'),
                incomeList: document.getElementById('income-list'),
                expenseList: document.getElementById('expense-list'),
                incomeCount: document.getElementById('income-count'),
                expenseCount: document.getElementById('expense-count'),
                incomeList: document.getElementById('income-list'),
                expenseList: document.getElementById('expense-list'),
                incomeCount: document.getElementById('income-count'),
                expenseCount: document.getElementById('expense-count'),
                btnNewTransaction: document.getElementById('btn-new-transaction'),
                btnQuickIncome: document.getElementById('btn-quick-income'),
                btnQuickExpense: document.getElementById('btn-quick-expense'),
                
                // Categories
                categoriesList: document.getElementById('categories-list'),
                
                // Charts
                chartCategories: document.getElementById('chart-categories'),
                chartFlow: document.getElementById('chart-flow'),
                chartCategoriesEmpty: document.getElementById('chart-categories-empty'),
                chartFlowEmpty: document.getElementById('chart-flow-empty'),
                
                // Transaction Modal
                modalTransaction: document.getElementById('modal-transaction'),
                formTransaction: document.getElementById('form-transaction'),
                btnCloseModal: document.getElementById('btn-close-modal'),
                btnCancelTransaction: document.getElementById('btn-cancel-transaction'),
                modalMessage: document.getElementById('modal-message'),
                modalMessageText: document.getElementById('modal-message-text'),
                txnRecurring: document.getElementById('txn-recurring'),
                recurringOptions: document.getElementById('recurring-options'),
                txnRecurringMonths: document.getElementById('txn-recurring-months'),
                recurringEndDate: document.getElementById('recurring-end-date'),
                
                // Category Modal
                modalCategory: document.getElementById('modal-category'),
                formCategory: document.getElementById('form-category'),
                btnCloseCategoryModal: document.getElementById('btn-close-category-modal'),
                btnCancelCategory: document.getElementById('btn-cancel-category'),
                categoryModalMessage: document.getElementById('category-modal-message'),
                categoryModalMessageText: document.getElementById('category-modal-message-text'),
                
                // Budget Modal
                modalBudget: document.getElementById('modal-budget'),
                budgetList: document.getElementById('budget-list'),
                btnCloseBudgetModal: document.getElementById('btn-close-budget-modal'),
                btnCancelBudget: document.getElementById('btn-cancel-budget'),
                btnSaveBudgets: document.getElementById('btn-save-budgets'),
                
                // Card Modal
                modalCard: document.getElementById('modal-card'),
                formCard: document.getElementById('form-card'),
                btnCloseCardModal: document.getElementById('btn-close-card-modal'),
                btnCancelCard: document.getElementById('btn-cancel-card'),
                cardModalMessage: document.getElementById('card-modal-message'),
                cardModalMessageText: document.getElementById('card-modal-message-text'),
                cardsContainer: document.getElementById('cards-container'),
                btnNewCard: document.getElementById('btn-new-card'),
                
                // Credit Audit Widget (FASE 12.6)
                creditAuditWidget: document.getElementById('credit-audit-widget'),
                creditPurchasesList: document.getElementById('credit-purchases-list'),
                creditPurchasesEmpty: document.getElementById('credit-purchases-empty'),
                
                // Delete Confirmation Modal (FASE 13)
                modalDeleteConfirm: document.getElementById('modal-delete-confirm'),
                btnCloseDeleteModal: document.getElementById('btn-close-delete-modal'),
                deleteTransactionInfo: document.getElementById('delete-transaction-info'),
                deleteTxnDescription: document.getElementById('delete-txn-description'),
                deleteTxnMeta: document.getElementById('delete-txn-meta'),
                deleteTxnValue: document.getElementById('delete-txn-value'),
                deleteMessageSingle: document.getElementById('delete-message-single'),
                deleteMessageRecurring: document.getElementById('delete-message-recurring'),
                deleteActionsSingle: document.getElementById('delete-actions-single'),
                deleteActionsRecurring: document.getElementById('delete-actions-recurring'),
                btnCancelDelete: document.getElementById('btn-cancel-delete'),
                btnDeleteSingleConfirm: document.getElementById('btn-delete-single-confirm'),
                btnDeleteThisOnly: document.getElementById('btn-delete-this-only'),
                btnDeleteThisAndFuture: document.getElementById('btn-delete-this-and-future'),
                btnCancelDeleteRecurring: document.getElementById('btn-cancel-delete-recurring'),
                
                viewCards: document.getElementById('view-cards'),
                txnPaymentMethod: document.getElementById('txn-payment-method'),
                txnCard: document.getElementById('txn-card'),
                txnInstallments: document.getElementById('txn-installments'),
                creditCardOptions: document.getElementById('credit-card-options'),
                installmentValue: document.getElementById('installment-value'),
                btnViewCards: document.getElementById('btn-view-cards'),
                btnViewDashboard: document.getElementById('btn-view-dashboard'),
                btnDashboardFromCards: document.getElementById('btn-dashboard-from-cards'),
                btnAddCard: document.getElementById('btn-add-card'),
                btnAddCardEmpty: document.getElementById('btn-add-card-empty'),
                cardsViewContainer: document.getElementById('cards-view-container'),
                cardsEmptyState: document.getElementById('cards-empty-state'),
                // FASE 14: Invoice Management UI Elements
                cardsMasterDetail: document.getElementById('cards-master-detail'),
                cardsSelectorList: document.getElementById('cards-selector-list'),
                invoiceSummaryPanel: document.getElementById('invoice-summary-panel'),
                invoiceTransactionsList: document.getElementById('invoice-transactions-list'),
                // FASE 14.7: Temporal Navigation Elements
                btnPrevCardMonth: document.getElementById('btn-prev-card-month'),
                btnNextCardMonth: document.getElementById('btn-next-card-month'),
                btnResetCardMonth: document.getElementById('btn-reset-card-month'),
                cardPeriodDisplay: document.getElementById('card-period-display'),
                // FASE 19: Settings & Theme
                btnOpenSettings: document.getElementById('btn-open-settings'),
                btnToggleTheme: document.getElementById('btn-toggle-theme'),
                themeIcon: document.getElementById('theme-icon'),
                themeText: document.getElementById('theme-text'),
                modalSettings: document.getElementById('modal-settings'),
                btnCloseSettings: document.getElementById('btn-close-settings'),
                tabProfile: document.getElementById('tab-profile'),
                tabData: document.getElementById('tab-data'),
                contentProfile: document.getElementById('content-profile'),
                contentData: document.getElementById('content-data'),
                settingsDisplayName: document.getElementById('settings-display-name'),
                settingsEmail: document.getElementById('settings-email'),
                btnSaveDisplayName: document.getElementById('btn-save-display-name'),
                btnCreateBackup: document.getElementById('btn-create-backup'),
                backupList: document.getElementById('backup-list'),
                btnResetAll: document.getElementById('btn-reset-all')
            },

            /**
             * Show a specific view and hide others
             */
            showView(viewName) {
                const views = ['login', 'dashboard', 'loading', 'cards'];
                views.forEach(view => {
                    const element = this.elements[`view${view.charAt(0).toUpperCase() + view.slice(1)}`];
                    if (element) {
                        element.classList.toggle('hidden', view !== viewName);
                    }
                });
                state.currentView = viewName;
                
                // Render cards view when switching to it
                if (viewName === 'cards') {
                    this.renderCardsView();
                }
            },

            /**
             * Toggle loading overlay
             */
            setLoading(isLoading) {
                state.loading = isLoading;
                this.elements.viewLoading.classList.toggle('hidden', !isLoading);
            },

            /**
             * Show authentication message (error or success)
             */
            showAuthMessage(message, type = 'error') {
                const messageEl = this.elements.authMessage;
                const textEl = this.elements.authMessageText;
                
                messageEl.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
                
                if (type === 'error') {
                    messageEl.classList.add('bg-red-50', 'text-red-700');
                    textEl.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
                } else {
                    messageEl.classList.add('bg-green-50', 'text-green-700');
                    textEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                }
            },

            /**
             * Update dashboard with user data
             */
            updateUserProfile(user) {
                const name = user.displayName || user.email.split('@')[0];
                const initials = name.charAt(0).toUpperCase();
                
                this.elements.userName.textContent = name;
                this.elements.userEmail.textContent = user.email;
                this.elements.userAvatar.textContent = initials;
            },

            /**
             * Update current date in header
             */
            updateCurrentDate() {
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                const dateStr = new Date().toLocaleDateString('pt-BR', options);
                this.elements.currentDate.textContent = dateStr;
            },

            /**
             * Update month navigation display
             */
            updateMonthDisplay() {
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const month = monthNames[state.currentDate.getMonth()];
                const year = state.currentDate.getFullYear();
                
                this.elements.currentMonthDisplay.textContent = `${month} ${year}`;
                
                // Show/hide "Hoje" button
                const now = new Date();
                const isCurrentMonth = state.currentDate.getMonth() === now.getMonth() &&
                                      state.currentDate.getFullYear() === now.getFullYear();
                
                if (isCurrentMonth) {
                    this.elements.btnToday.classList.add('hidden');
                } else {
                    this.elements.btnToday.classList.remove('hidden');
                }
            },

            /**
             * Navigate to previous month
             */
            prevMonth() {
                state.currentDate = new Date(
                    state.currentDate.getFullYear(),
                    state.currentDate.getMonth() - 1,
                    1
                );
                this.updateMonthDisplay();
                this.renderTransactionList();
                this.renderCreditAuditWidget();
                this.updateDashboardCards(state.transactions);
                this.renderCharts();
            },

            /**
             * Navigate to next month
             */
            nextMonth() {
                state.currentDate = new Date(
                    state.currentDate.getFullYear(),
                    state.currentDate.getMonth() + 1,
                    1
                );
                this.updateMonthDisplay();
                this.renderTransactionList();
                this.renderCreditAuditWidget();
                this.updateDashboardCards(state.transactions);
                this.renderCharts();
            },

            /**
             * Return to current month (today)
             */
            goToToday() {
                state.currentDate = new Date();
                this.updateMonthDisplay();
                this.renderTransactionList();
                this.renderCreditAuditWidget();
                this.updateDashboardCards(state.transactions);
                this.renderCharts();
            },

            /**
             * Toggle between login and register forms
             */
            toggleAuthForm(formType) {
                const isLogin = formType === 'login';
                
                this.elements.formLogin.classList.toggle('hidden', !isLogin);
                this.elements.formRegister.classList.toggle('hidden', isLogin);
                
                // Update tab styles
                const activeClasses = ['bg-white', 'text-emerald-600', 'shadow-sm'];
                const inactiveClasses = ['text-slate-600', 'hover:text-slate-800'];
                
                if (isLogin) {
                    this.elements.tabLogin.classList.add(...activeClasses);
                    this.elements.tabLogin.classList.remove(...inactiveClasses);
                    this.elements.tabRegister.classList.remove(...activeClasses);
                    this.elements.tabRegister.classList.add(...inactiveClasses);
                } else {
                    this.elements.tabRegister.classList.add(...activeClasses);
                    this.elements.tabRegister.classList.remove(...inactiveClasses);
                    this.elements.tabLogin.classList.remove(...activeClasses);
                    this.elements.tabLogin.classList.add(...inactiveClasses);
                }
                
                // Clear message
                this.elements.authMessage.classList.add('hidden');
            },

            /**
             * Show/hide transaction modal
             * FASE 17: Smart Defaults - Prever inten√ß√£o baseada em navega√ß√£o
             * @param {string} type - 'receita' or 'despesa' (only for new transactions)
             * @param {Object} transaction - Transaction object for editing (optional)
             */
            showTransactionModal(type = 'despesa', transaction = null) {
                this.elements.modalTransaction.classList.remove('hidden');
                
                if (transaction) {
                    // EDIT MODE
                    state.editingTransaction = transaction;
                    
                    // Update modal title
                    document.getElementById('modal-title').textContent = 'Editar Transa√ß√£o';
                    
                    // Update button text
                    document.querySelector('#form-transaction button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Atualizar';
                    
                    // Pre-fill form
                    document.getElementById('txn-description').value = transaction.description;
                    document.getElementById('txn-value').value = transaction.value;
                    document.getElementById('txn-category').value = transaction.category;
                    document.getElementById('txn-status').value = transaction.status;
                    
                    // Set date
                    const date = new Date(transaction.date);
                    document.getElementById('txn-date').valueAsDate = date;
                    
                    // Select type
                    const radioButton = document.querySelector(`input[name="type"][value="${transaction.type}"]`);
                    if (radioButton) radioButton.checked = true;
                    
                    // Hide recurrence for editing (only for new transactions)
                    this.elements.txnRecurring.checked = false;
                    this.elements.recurringOptions.classList.add('hidden');
                    this.elements.txnRecurring.closest('.border-t').classList.add('hidden');
                    
                } else {
                    // CREATE MODE
                    state.editingTransaction = null;
                    
                    // Update modal title
                    document.getElementById('modal-title').textContent = 'Nova Transa√ß√£o';
                    
                    // Update button text
                    document.querySelector('#form-transaction button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Salvar';
                    
                    // FASE 17: Smart Default - Tipo = 'despesa'
                    const defaultType = 'despesa';
                    const radioButton = document.querySelector(`input[name="type"][value="${defaultType}"]`);
                    if (radioButton) {
                        radioButton.checked = true;
                        // Disparar evento para aplicar estilos visuais
                        radioButton.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // FASE 17: Smart Default - Status = 'pendente'
                    document.getElementById('txn-status').value = 'pendente';
                    
                    // FASE 17: Smart Default - Data Inteligente baseada em navega√ß√£o
                    const now = new Date();
                    const viewedMonth = state.currentDate.getMonth();
                    const viewedYear = state.currentDate.getFullYear();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    let defaultDate;
                    if (viewedMonth === currentMonth && viewedYear === currentYear) {
                        // M√™s visualizado = M√™s atual ‚Üí Usar HOJE
                        defaultDate = now;
                        logger.log('üìÖ Smart Default: Data = Hoje (m√™s atual)');
                    } else {
                        // M√™s visualizado ‚â† M√™s atual ‚Üí Usar DIA 01 do m√™s visualizado
                        defaultDate = new Date(viewedYear, viewedMonth, 1);
                        logger.log(`üìÖ Smart Default: Data = 01/${viewedMonth + 1}/${viewedYear} (m√™s navegado)`);
                    }
                    
                    document.getElementById('txn-date').valueAsDate = defaultDate;
                    
                    // Reset payment method to cash
                    this.elements.txnPaymentMethod.value = 'cash';
                    this.elements.creditCardOptions.classList.add('hidden');
                    this.elements.txnInstallments.value = 1;
                    this.elements.installmentValue.textContent = 'R$ 0,00';
                    
                    // Enable recurrence
                    this.elements.txnRecurring.disabled = false;
                    
                    // Show recurrence section and reset
                    this.elements.txnRecurring.closest('.border-t').classList.remove('hidden');
                    this.elements.txnRecurring.checked = false;
                    this.elements.recurringOptions.classList.add('hidden');
                    this.elements.txnRecurringMonths.value = 12;
                }
                
                // Focus first input
                setTimeout(() => document.getElementById('txn-description').focus(), 100);
            },

            hideTransactionModal() {
                this.elements.modalTransaction.classList.add('hidden');
                this.elements.formTransaction.reset();
                this.elements.modalMessage.classList.add('hidden');
                state.editingTransaction = null;
            },

            /**
             * Show modal message
             */
            showModalMessage(message, type = 'error') {
                const messageEl = this.elements.modalMessage;
                const textEl = this.elements.modalMessageText;
                
                messageEl.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
                
                if (type === 'error') {
                    messageEl.classList.add('bg-red-50', 'text-red-700');
                    textEl.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
                } else {
                    messageEl.classList.add('bg-green-50', 'text-green-700');
                    textEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                }
            },

            /**
             * Show category modal
             */
            showCategoryModal() {
                this.elements.modalCategory.classList.remove('hidden');
                this.elements.formCategory.reset();
                this.elements.categoryModalMessage.classList.add('hidden');
                
                // Reset icon selection
                document.getElementById('cat-icon').value = 'üìÅ';
                document.getElementById('selected-icon').textContent = 'üìÅ';
                document.querySelectorAll('.icon-selector').forEach(btn => {
                    btn.classList.remove('bg-emerald-100', 'ring-2', 'ring-emerald-500');
                });
                
                // Focus first input
                setTimeout(() => document.getElementById('cat-name').focus(), 100);
            },

            hideCategoryModal() {
                this.elements.modalCategory.classList.add('hidden');
                this.elements.formCategory.reset();
                this.elements.categoryModalMessage.classList.add('hidden');
            },

            /**
             * Show category modal message
             */
            showCategoryModalMessage(message, type = 'error') {
                const messageEl = this.elements.categoryModalMessage;
                const textEl = this.elements.categoryModalMessageText;
                
                messageEl.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
                
                if (type === 'error') {
                    messageEl.classList.add('bg-red-50', 'text-red-700');
                    textEl.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
                } else {
                    messageEl.classList.add('bg-green-50', 'text-green-700');
                    textEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                }
            },

            /**
             * Update dashboard summary cards - "Card Camale√£o"
             * Comportamento h√≠brido: Passado = Saldo Acumulado | Presente/Futuro = Resultado do M√™s
             * Receitas/Despesas: Sempre do m√™s selecionado
             */
            updateDashboardCards(transactions) {
                const currentMonth = state.currentDate.getMonth();
                const currentYear = state.currentDate.getFullYear();
                
                // Helper: Check if selected month is current or future
                const now = new Date();
                const isCurrentOrFutureMonth = (currentYear > now.getFullYear()) || 
                                               (currentYear === now.getFullYear() && currentMonth >= now.getMonth());
                
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                let balance;
                let labelText;
                
                if (isCurrentOrFutureMonth) {
                    // CEN√ÅRIO B: Presente/Futuro - Mostra "Resultado do M√™s"
                    const monthIncome = transactions
                        .filter(t => {
                            const txnDate = new Date(t.date);
                            return t.type === 'receita' && 
                                   t.status === 'confirmada' &&
                                   txnDate.getMonth() === currentMonth &&
                                   txnDate.getFullYear() === currentYear;
                        })
                        .reduce((sum, t) => sum + t.value, 0);
                    
                    const monthExpense = transactions
                        .filter(t => {
                            const txnDate = new Date(t.date);
                            return t.type === 'despesa' && 
                                   t.status === 'confirmada' &&
                                   txnDate.getMonth() === currentMonth &&
                                   txnDate.getFullYear() === currentYear;
                        })
                        .reduce((sum, t) => sum + t.value, 0);
                    
                    balance = monthIncome - monthExpense;
                    labelText = `Resultado de ${monthNames[currentMonth]}`;
                    
                    // Update card color based on result (green = profit, red = loss)
                    if (balance < 0) {
                        this.elements.cardBalance.classList.remove('text-white');
                        this.elements.cardBalance.classList.add('text-rose-100');
                    } else {
                        this.elements.cardBalance.classList.remove('text-rose-100');
                        this.elements.cardBalance.classList.add('text-white');
                    }
                    
                } else {
                    // CEN√ÅRIO A: Passado - Mostra "Saldo Acumulado at√© [M√™s]"
                    const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
                    
                    const historicalIncome = transactions
                        .filter(t => t.type === 'receita' && 
                                     t.status === 'confirmada' &&
                                     t.date <= lastDayOfMonth.getTime())
                        .reduce((sum, t) => sum + t.value, 0);
                    
                    const historicalExpense = transactions
                        .filter(t => t.type === 'despesa' && 
                                     t.status === 'confirmada' &&
                                     t.date <= lastDayOfMonth.getTime())
                        .reduce((sum, t) => sum + t.value, 0);
                    
                    balance = historicalIncome - historicalExpense;
                    labelText = `Saldo em ${monthNames[currentMonth]}`;
                    
                    // Always white for historical balance
                    this.elements.cardBalance.classList.remove('text-rose-100');
                    this.elements.cardBalance.classList.add('text-white');
                }
                
                // Update label (Camale√£o effect)
                this.elements.balanceLabel.textContent = labelText;
                
                // Update balance value
                this.elements.cardBalance.textContent = formatCurrency(balance);
                
                // Current month income/expenses (always month-specific)
                const monthIncome = transactions
                    .filter(t => {
                        const txnDate = new Date(t.date);
                        return t.type === 'receita' && 
                               t.status === 'confirmada' &&
                               txnDate.getMonth() === currentMonth &&
                               txnDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, t) => sum + t.value, 0);
                
                const monthExpense = transactions
                    .filter(t => {
                        const txnDate = new Date(t.date);
                        return t.type === 'despesa' && 
                               t.status === 'confirmada' &&
                               txnDate.getMonth() === currentMonth &&
                               txnDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, t) => sum + t.value, 0);
                
                this.elements.cardIncome.textContent = formatCurrency(monthIncome);
                this.elements.cardExpense.textContent = formatCurrency(monthExpense);
            },

            /**
             * Render transactions list - Fintech Premium Design
             * Now uses filtered data from getFilteredTransactions()
             */
            renderTransactionList() {
                const incomeListEl = this.elements.incomeList;
                const expenseListEl = this.elements.expenseList;
                const incomeCountEl = this.elements.incomeCount;
                const expenseCountEl = this.elements.expenseCount;
                
                if (!incomeListEl || !expenseListEl) return;
                
                // Get filtered and sorted transactions (respects currentDate month filter)
                const transactions = getFilteredTransactions();
                
                // Separate into income and expenses
                const incomes = transactions.filter(t => t.type === 'receita');
                const expenses = transactions.filter(t => t.type === 'despesa');
                
                // Update counts
                if (incomeCountEl) incomeCountEl.textContent = incomes.length;
                if (expenseCountEl) expenseCountEl.textContent = expenses.length;
                
                // Merge all categories for lookup
                const allCategories = { ...state.categories.global, ...state.categories.personal };
                
                logger.log('üîç Renderizando transa√ß√µes separadas. Entradas:', incomes.length, 'Sa√≠das:', expenses.length);
                
                // Helper function to render a transaction item
                const renderTransaction = (txn) => {
                    // Get category details
                    const category = allCategories[txn.category];
                    const categoryName = category ? category.name : txn.category;
                    const categoryIcon = category ? category.icon : 'üì¶';
                    
                    const isIncome = txn.type === 'receita';
                    const colorClass = isIncome ? 'text-emerald-600' : 'text-rose-600';
                    const bgGradient = isIncome 
                        ? 'bg-gradient-to-br from-emerald-100 to-emerald-50' 
                        : 'bg-gradient-to-br from-rose-100 to-rose-50';
                    const borderColor = isIncome ? 'border-emerald-200' : 'border-rose-200';
                    const icon = isIncome ? 'fa-arrow-up' : 'fa-arrow-down';
                    const statusBadge = txn.status === 'confirmada' 
                        ? `<button onclick="event.stopPropagation(); toggleTransactionStatus('${txn.id}', 'confirmada')" class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 hover:bg-emerald-200 rounded-full transition-all cursor-pointer" title="Clique para marcar como pendente"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span></button>` 
                        : `<button onclick="event.stopPropagation(); toggleTransactionStatus('${txn.id}', 'pendente')" class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 hover:bg-amber-200 rounded-full transition-all cursor-pointer" title="Clique para marcar como confirmada"><span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span></button>`;
                    
                    return `
                        <div class="px-4 md:px-6 py-4 hover:bg-slate-50/50 transition-all group">
                            <div class="flex items-center gap-4">
                                <!-- Icon Circle -->
                                <div onclick="openTransactionForEdit('${txn.id}')" class="relative flex-shrink-0 cursor-pointer">
                                    <div class="${bgGradient} ${borderColor} border-2 w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 hover:scale-110 transition-transform duration-200">
                                        <span class="text-2xl">${categoryIcon}</span>
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-white rounded-full flex items-center justify-center shadow-md border-2 ${borderColor}">
                                        <i class="fas ${icon} ${colorClass} text-[10px]"></i>
                                    </div>
                                </div>
                                
                                <!-- Transaction Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-bold text-slate-800 text-base truncate">
                                            ${txn.description}
                                            ${txn.installment ? `<span class="text-xs text-slate-400 font-normal">(${txn.installment.current}/${txn.installment.total})</span>` : ''}
                                        </h4>
                                        ${statusBadge}
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-slate-500">
                                        <span class="font-medium">${categoryName}</span>
                                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                        <span>${formatDate(txn.date)}</span>
                                        ${txn.installment && txn.installment.current === txn.installment.total ? `
                                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                        <button 
                                            onclick="event.stopPropagation(); extendRecurrence('${txn.groupId}', '${txn.id}')" 
                                            class="text-emerald-600 hover:text-emerald-700 font-semibold hover:underline"
                                            title="Prorrogar +12 meses"
                                        >
                                            üîÑ Prorrogar +12m
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Value & Actions -->
                                <div class="flex items-center gap-3 flex-shrink-0">
                                    <div onclick="openTransactionForEdit('${txn.id}')" class="text-right cursor-pointer hover:scale-105 transition-transform p-2 -m-2 rounded-lg hover:bg-slate-100">
                                        <p class="text-lg md:text-xl font-bold ${colorClass} tracking-tight">
                                            ${isIncome ? '+' : '-'} ${formatCurrency(txn.value)}
                                        </p>
                                        <p class="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">
                                            ${txn.status === 'confirmada' ? 'Confirmada' : 'Pendente'}
                                        </p>
                                    </div>
                                    <button 
                                        onclick="event.stopPropagation(); deleteTransaction('${txn.id}')" 
                                        class="opacity-0 group-hover:opacity-100 w-10 h-10 flex items-center justify-center text-rose-500 hover:bg-rose-50 rounded-xl transition-all transform hover:scale-110"
                                        title="Excluir transa√ß√£o"
                                    >
                                        <i class="fas fa-trash-alt text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                // Render Income List
                if (incomes.length === 0) {
                    incomeListEl.innerHTML = `
                        <li class="p-8 text-center text-slate-400">
                            <i class="fas fa-leaf text-3xl mb-2"></i>
                            <p class="text-sm font-medium">Nenhuma entrada neste per√≠odo üçÉ</p>
                        </li>
                    `;
                } else {
                    incomeListEl.innerHTML = incomes.map(txn => renderTransaction(txn)).join('');
                }
                
                // Render Expense List
                if (expenses.length === 0) {
                    expenseListEl.innerHTML = `
                        <li class="p-8 text-center text-slate-400">
                            <i class="fas fa-sparkles text-3xl mb-2"></i>
                            <p class="text-sm font-medium">Nenhuma sa√≠da registrada ‚ú®</p>
                        </li>
                    `;
                } else {
                    expenseListEl.innerHTML = expenses.map(txn => renderTransaction(txn)).join('');
                }
            },

            /**
             * FASE 12.6: Render Credit Audit Widget
             * Shows all credit purchases made in the current viewed month,
             * regardless of when the invoice is due
             */
            renderCreditAuditWidget() {
                const listEl = this.elements.creditPurchasesList;
                const emptyEl = this.elements.creditPurchasesEmpty;
                
                if (!listEl || !emptyEl) return;
                
                // Get current month range from state.currentDate
                const year = state.currentDate.getFullYear();
                const month = state.currentDate.getMonth();
                const monthStart = new Date(year, month, 1).getTime();
                const monthEnd = new Date(year, month + 1, 0, 23, 59, 59).getTime();
                
                // Filter: Credit purchases made THIS MONTH (by purchaseDate)
                const creditPurchases = state.transactions.filter(t => 
                    t.paymentMethod === 'credit' &&
                    t.purchaseDate &&
                    t.purchaseDate >= monthStart &&
                    t.purchaseDate <= monthEnd
                );
                
                // Show/hide empty state
                if (creditPurchases.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    return;
                }
                
                emptyEl.classList.add('hidden');
                
                // Group by groupId and show only first installment of each purchase
                const uniquePurchases = new Map();
                creditPurchases.forEach(t => {
                    if (t.groupId && !uniquePurchases.has(t.groupId)) {
                        uniquePurchases.set(t.groupId, t);
                    }
                });
                
                // Render compact purchase list
                listEl.innerHTML = Array.from(uniquePurchases.values())
                    .sort((a, b) => b.purchaseDate - a.purchaseDate) // Most recent first
                    .map(txn => {
                        const purchaseDate = new Date(txn.purchaseDate);
                        const dueDate = new Date(txn.date);
                        const card = state.cards.find(c => c.id === txn.cardId);
                        
                        // Determine if purchase is for next invoice
                        const purchaseMonth = purchaseDate.getMonth();
                        const dueMonth = dueDate.getMonth();
                        const isNextMonth = dueMonth !== purchaseMonth;
                        
                        // Extract base description (remove installment info)
                        const baseDescription = txn.description.replace(/\s*\(\d+\/\d+\)$/, '');
                        
                        // Calculate total value (all installments)
                        const totalValue = txn.installment ? txn.value * txn.installment.total : txn.value;
                        
                        return `
                            <div class="p-3 bg-blue-50/30 border border-blue-100 rounded-xl hover:bg-blue-50/50 transition-all">
                                <div class="flex items-start justify-between mb-1.5">
                                    <div class="flex-1 min-w-0 pr-2">
                                        <p class="text-sm font-semibold text-slate-700 truncate">${baseDescription}</p>
                                        <p class="text-xs text-slate-500 mt-0.5">
                                            <i class="fas fa-calendar-alt mr-1"></i>${purchaseDate.toLocaleDateString('pt-BR')}
                                            ${card ? ` ‚Ä¢ <i class="fas fa-credit-card mr-1"></i>${card.name}` : ''}
                                        </p>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <p class="text-sm font-bold text-rose-600">${formatCurrency(totalValue)}</p>
                                        ${txn.installment ? `<p class="text-xs text-slate-500">${txn.installment.total}x</p>` : ''}
                                    </div>
                                </div>
                                ${isNextMonth ? `
                                    <div class="inline-flex items-center px-2 py-1 bg-amber-100 border border-amber-200 rounded-lg">
                                        <i class="fas fa-arrow-right text-amber-600 text-xs mr-1.5"></i>
                                        <span class="text-xs font-semibold text-amber-700">
                                            Fatura ${dueDate.toLocaleDateString('pt-BR', { month: 'short' })}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
            },

            /**
             * Render dynamic category list with transaction counts
             */
            renderCategoryList() {
                const container = this.elements.categoriesList;
                if (!container) return;
                
                // Merge global + personal categories
                const allCategories = {
                    ...state.categories.global,
                    ...state.categories.personal
                };
                
                // Calculate selected month spending per category
                const selectedMonth = state.currentDate.getMonth();
                const selectedYear = state.currentDate.getFullYear();
                const selectedMonthStart = new Date(selectedYear, selectedMonth, 1).getTime();
                const selectedMonthEnd = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59).getTime();
                
                const categorySpending = {};
                const categoryCounts = {};
                
                // FILTRAR APENAS PELO M√äS SELECIONADO
                state.transactions.forEach(txn => {
                    if (txn.category && txn.date >= selectedMonthStart && txn.date <= selectedMonthEnd) {
                        // Contar transa√ß√µes do m√™s selecionado
                        categoryCounts[txn.category] = (categoryCounts[txn.category] || 0) + 1;
                        
                        // Somar gastos apenas de transa√ß√µes confirmadas do m√™s selecionado
                        if (txn.status === 'confirmada') {
                            if (!categorySpending[txn.category]) {
                                categorySpending[txn.category] = 0;
                            }
                            categorySpending[txn.category] += txn.value;
                        }
                    }
                });
                
                // Criar lista SOMENTE com categorias que t√™m transa√ß√µes no m√™s selecionado
                const categoriesWithTransactions = Object.keys(categoryCounts); // Apenas IDs com transa√ß√µes
                
                if (categoriesWithTransactions.length === 0) {
                    // Nenhuma categoria tem transa√ß√µes neste m√™s
                    const monthNames = [
                        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                    ];
                    const currentMonthName = monthNames[selectedMonth];
                    
                    container.innerHTML = `
                        <div class="p-4 text-center text-slate-400 text-sm">
                            <i class="fas fa-calendar-times text-2xl mb-2"></i>
                            <p class="font-medium">Nenhuma transa√ß√£o</p>
                            <p class="text-xs mt-1">em ${currentMonthName}</p>
                        </div>
                    `;
                    return;
                }
                
                // Mapear apenas as categorias que t√™m transa√ß√µes
                const sortedCategories = categoriesWithTransactions
                    .map(key => {
                        const cat = allCategories[key];
                        if (!cat) return null; // Categoria n√£o existe mais
                        
                        return {
                            key,
                            ...cat,
                            count: categoryCounts[key],
                            spending: categorySpending[key] || 0
                        };
                    })
                    .filter(cat => cat !== null) // Remove categorias deletadas
                    .sort((a, b) => a.name.localeCompare(b.name)); // Ordena alfabeticamente (A-Z)
                
                // Renderizar as categorias (j√° filtradas)
                container.innerHTML = sortedCategories.map(cat => {
                    const isPersonal = state.categories.personal && state.categories.personal[cat.key];
                    const badgeColor = cat.count > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400';
                    const isActive = state.filters.category === cat.key;
                    const activeClasses = isActive ? 'ring-2 ring-emerald-500 bg-slate-50 shadow-sm' : '';
                    
                    // Budget progress bar logic - APENAS PARA O M√äS SELECIONADO
                    const budget = state.budgets[cat.key];
                    let progressBarHTML = '';
                    
                    if (budget && budget > 0 && cat.spending > 0) {
                        // cat.spending j√° foi calculado apenas para o m√™s selecionado
                        const spent = cat.spending;
                        const percentage = Math.min((spent / budget) * 100, 100);
                        
                        // Determine color based on percentage
                        let barColor = 'bg-emerald-500'; // <75%
                        let alertIcon = '';
                        
                        if (percentage >= 100) {
                            barColor = 'bg-rose-500';
                            alertIcon = '<i class="fas fa-exclamation-triangle text-rose-500 text-xs ml-1"></i>';
                        } else if (percentage >= 75) {
                            barColor = 'bg-amber-400';
                        }
                        
                        progressBarHTML = `
                            <div class="mt-2 text-[10px] text-slate-500">
                                <div class="flex items-center justify-between mb-1">
                                    <span>R$ ${spent.toFixed(2)} de R$ ${budget.toFixed(2)}</span>
                                    <span class="font-semibold">${percentage.toFixed(0)}%${alertIcon}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-1 overflow-hidden">
                                    <div class="${barColor} h-full rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    } else if (budget && budget > 0 && cat.spending === 0) {
                        // Mostra meta dispon√≠vel sem gastos no m√™s
                        progressBarHTML = `
                            <div class="mt-2 text-[10px] text-slate-400">
                                <div class="flex items-center justify-between">
                                    <span>Meta: R$ ${budget.toFixed(2)}</span>
                                    <span class="font-semibold text-emerald-600">0%</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div onclick="toggleCategoryFilter('${cat.key}')" class="p-3 rounded-xl hover:bg-slate-50 transition-all cursor-pointer group ${activeClasses}">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl group-hover:scale-110 transition-transform">${cat.icon}</span>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-semibold text-slate-700">${cat.name}</span>
                                        ${isPersonal ? '<span class="text-[10px] text-purple-500 font-medium">Pessoal</span>' : ''}
                                    </div>
                                </div>
                                <span class="text-xs font-bold ${badgeColor} px-2 py-1 rounded-full">${cat.count}</span>
                            </div>
                            ${progressBarHTML}
                        </div>
                    `;
                }).join('');
            },

            /**
             * Toggle category filter
             * @param {string} categoryId - Category ID to filter by
             */
            toggleCategoryFilter(categoryId) {
                // Toggle: if already active, deactivate; otherwise activate
                if (state.filters.category === categoryId) {
                    state.filters.category = null;
                    logger.log('üîç Filtro de categoria removido');
                } else {
                    state.filters.category = categoryId;
                    logger.log('üîç Filtrando por categoria:', categoryId);
                }
                
                // Update UI
                this.renderTransactionList();
                this.renderCreditAuditWidget();
                this.renderCategoryList();
            },

            /**
             * Render financial charts
             */
            renderCharts() {
                if (!this.elements.chartCategories || !this.elements.chartFlow) return;
                
                const transactions = state.transactions;
                
                // Check if there are transactions
                if (transactions.length === 0) {
                    // Show empty states
                    this.elements.chartCategories.classList.add('hidden');
                    this.elements.chartCategoriesEmpty.classList.remove('hidden');
                    this.elements.chartFlow.classList.add('hidden');
                    this.elements.chartFlowEmpty.classList.remove('hidden');
                    return;
                }
                
                // Hide empty states
                this.elements.chartCategories.classList.remove('hidden');
                this.elements.chartCategoriesEmpty.classList.add('hidden');
                this.elements.chartFlow.classList.remove('hidden');
                this.elements.chartFlowEmpty.classList.add('hidden');
                
                // Process data
                const chartData = processChartData(transactions);
                
                // Destroy previous chart instances
                if (categoryChartInstance) {
                    categoryChartInstance.destroy();
                    categoryChartInstance = null;
                }
                if (flowChartInstance) {
                    flowChartInstance.destroy();
                    flowChartInstance = null;
                }
                
                // Render Category Chart (Doughnut)
                if (chartData.categories.labels.length > 0) {
                    const ctx1 = this.elements.chartCategories.getContext('2d');
                    categoryChartInstance = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: chartData.categories.labels,
                            datasets: [{
                                data: chartData.categories.values,
                                backgroundColor: [
                                    '#f43f5e', // rose-500
                                    '#f59e0b', // amber-500
                                    '#3b82f6', // blue-500
                                    '#8b5cf6', // violet-500
                                    '#06b6d4', // cyan-500
                                    '#94a3b8'  // slate-400
                                ],
                                borderWidth: 0,
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            family: 'system-ui'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return ` R$ ${value.toFixed(2).replace('.', ',')} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Render Flow Chart (Bar)
                if (chartData.flow.labels.length > 0) {
                    const ctx2 = this.elements.chartFlow.getContext('2d');
                    flowChartInstance = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: chartData.flow.labels,
                            datasets: [
                                {
                                    label: 'Receitas',
                                    data: chartData.flow.income,
                                    backgroundColor: '#10b981',
                                    borderRadius: 4,
                                    barThickness: 20
                                },
                                {
                                    label: 'Despesas',
                                    data: chartData.flow.expenses,
                                    backgroundColor: '#f43f5e',
                                    borderRadius: 4,
                                    barThickness: 20
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.1)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return 'R$ ' + value.toFixed(0);
                                        },
                                        font: { size: 11 }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: { size: 11 }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        padding: 10,
                                        font: {
                                            size: 12,
                                            family: 'system-ui'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        boxWidth: 8,
                                        boxHeight: 8
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            return ` ${context.dataset.label}: R$ ${context.parsed.y.toFixed(2).replace('.', ',')}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                logger.log('üìä Gr√°ficos renderizados com sucesso');
            }
        };

        // ============================================
        // DATA PROCESSING FOR CHARTS
        // ============================================
        
        /**
         * Process transaction data for charts
         * @param {Array} transactions - Array of transactions
         * @returns {Object} Processed data for charts
         */
        function processChartData(transactions) {
            const allCategories = { ...state.categories.global, ...state.categories.personal };
            
            // Filter transactions for current selected month (for category chart)
            const currentMonth = state.currentDate.getMonth();
            const currentYear = state.currentDate.getFullYear();
            
            const currentMonthTransactions = transactions.filter(txn => {
                const txnDate = new Date(txn.date);
                return txnDate.getMonth() === currentMonth && 
                       txnDate.getFullYear() === currentYear;
            });
            
            // 1. Expenses by Category (Top 5 + Others) - CURRENT MONTH ONLY
            const expensesByCategory = {};
            
            currentMonthTransactions
                .filter(txn => txn.type === 'despesa' && txn.status === 'confirmada')
                .forEach(txn => {
                    const catName = allCategories[txn.category]?.name || txn.category;
                    expensesByCategory[catName] = (expensesByCategory[catName] || 0) + txn.value;
                });
            
            // Sort and get top 5
            const sortedExpenses = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1]);
            
            const top5 = sortedExpenses.slice(0, 5);
            const others = sortedExpenses.slice(5).reduce((sum, [, value]) => sum + value, 0);
            
            const categoryLabels = top5.map(([name]) => name);
            const categoryValues = top5.map(([, value]) => value);
            
            if (others > 0) {
                categoryLabels.push('Outros');
                categoryValues.push(others);
            }
            
            // 2. Income vs Expenses Flow (Last 6 months)
            const now = new Date();
            const months = [];
            const monthlyIncome = [];
            const monthlyExpenses = [];
            
            // Generate last 6 months
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = d.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })
                    .replace('.', '')
                    .replace(/^\w/, c => c.toUpperCase());
                
                months.push({ key: monthKey, label: monthLabel });
                monthlyIncome.push(0);
                monthlyExpenses.push(0);
            }
            
            // Aggregate transactions by month
            transactions
                .filter(txn => txn.status === 'confirmada')
                .forEach(txn => {
                    const txnDate = new Date(txn.date);
                    const txnKey = `${txnDate.getFullYear()}-${String(txnDate.getMonth() + 1).padStart(2, '0')}`;
                    
                    const monthIndex = months.findIndex(m => m.key === txnKey);
                    if (monthIndex !== -1) {
                        if (txn.type === 'receita') {
                            monthlyIncome[monthIndex] += txn.value;
                        } else {
                            monthlyExpenses[monthIndex] += txn.value;
                        }
                    }
                });
            
            return {
                categories: {
                    labels: categoryLabels,
                    values: categoryValues
                },
                flow: {
                    labels: months.map(m => m.label),
                    income: monthlyIncome,
                    expenses: monthlyExpenses
                }
            };
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        /**
         * Register a new user with email/password and save to database
         * @param {string} email - User email
         * @param {string} password - User password
         * @param {string} name - User full name
         * @returns {Promise<void>}
         */
        async function registerUser(email, password, name) {
            try {
                // Create Firebase Auth user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                
                // Immediately write user profile to Realtime Database
                await set(ref(database, `users/${userId}`), {
                    name: name,
                    email: email,
                    createdAt: Date.now(),
                    settings: {
                        theme: 'light',
                        currency: 'BRL',
                        notifications: true
                    }
                });
                
                logger.log('‚úÖ Usu√°rio registrado com sucesso:', userId);
                ui.showAuthMessage('Conta criada com sucesso! Bem-vindo!', 'success');
                
                // onAuthStateChanged will handle the rest
            } catch (error) {
                logger.error('‚ùå Erro no registro:', error);
                
                // Handle specific registration errors
                if (error.code === 'auth/email-already-in-use') {
                    throw new Error('Este e-mail j√° est√° cadastrado. Tente fazer login.');
                } else if (error.code === 'auth/invalid-email') {
                    throw new Error('E-mail inv√°lido. Verifique e tente novamente.');
                } else if (error.code === 'auth/weak-password') {
                    throw new Error('Senha muito fraca. Use no m√≠nimo 6 caracteres.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    throw new Error('Opera√ß√£o n√£o permitida. Contate o administrador.');
                } else if (error.code === 'auth/network-request-failed') {
                    throw new Error('Falha na conex√£o. Verifique sua internet.');
                } else {
                    throw new Error('Erro ao criar conta. Tente novamente.');
                }
            }
        }

        /**
         * Login user with email and password
         * @param {string} email - User email
         * @param {string} password - User password
         * @returns {Promise<void>}
         */
        async function loginUser(email, password) {
            try {
                // Sign in with Firebase Auth
                await signInWithEmailAndPassword(auth, email, password);
                logger.log('‚úÖ Login bem-sucedido');
                
                // Don't manually redirect - let onAuthStateChanged handle UI updates
            } catch (error) {
                logger.error('‚ùå Erro no login:', error);
                
                // Handle specific login errors
                if (error.code === 'auth/user-not-found') {
                    throw new Error('Usu√°rio n√£o encontrado. Verifique o e-mail.');
                } else if (error.code === 'auth/wrong-password') {
                    throw new Error('Senha incorreta. Tente novamente.');
                } else if (error.code === 'auth/invalid-email') {
                    throw new Error('E-mail inv√°lido.');
                } else if (error.code === 'auth/user-disabled') {
                    throw new Error('Esta conta foi desativada.');
                } else if (error.code === 'auth/invalid-credential') {
                    throw new Error('Credenciais inv√°lidas. Verifique e-mail e senha.');
                } else if (error.code === 'auth/too-many-requests') {
                    throw new Error('Muitas tentativas. Aguarde alguns minutos.');
                } else if (error.code === 'auth/network-request-failed') {
                    throw new Error('Falha na conex√£o. Verifique sua internet.');
                } else {
                    throw new Error('Erro ao fazer login. Tente novamente.');
                }
            }
        }

        /**
         * Logout current user
         * @returns {Promise<void>}
         */
        async function logoutUser() {
            try {
                await signOut(auth);
                logger.log('‚úÖ Logout realizado');
                // onAuthStateChanged will handle UI reset
            } catch (error) {
                logger.error('‚ùå Erro no logout:', error);
                throw new Error('Erro ao sair. Tente novamente.');
            }
        }

        // ============================================
        // TRANSACTIONS CRUD FUNCTIONS
        // ============================================
        
        /**
         * FASE 14: Get Invoice Data
         * Calculate invoice details for a card in a specific month
         * @param {Object} card - Credit card object
         * @param {number} month - Month (0-11)
         * @param {number} year - Year (e.g., 2025)
         * @returns {Object} Invoice data: { total, status, transactions, dueDate, closingDate }
         */
        function getInvoiceData(card, month, year) {
            const invoiceKey = `${card.id}_${year}${String(month + 1).padStart(2, '0')}`;
            
            // Check if invoice is paid (exists in invoices node)
            if (state.invoices[invoiceKey]) {
                const paidInvoice = state.invoices[invoiceKey];
                return {
                    total: paidInvoice.amount,
                    status: 'paid',
                    transactions: [],
                    dueDate: new Date(year, month, card.dueDay),
                    closingDate: new Date(year, month, card.closingDay),
                    paidAt: paidInvoice.paidAt,
                    transactionId: paidInvoice.transactionId
                };
            }
            
            // Calculate dynamically from transactions
            const invoiceTransactions = state.transactions.filter(t => {
                if (t.paymentMethod !== 'credit' || t.cardId !== card.id) {
                    return false;
                }
                
                // Transaction belongs to this invoice if its due date falls in this month
                const txnDate = new Date(t.date);
                const txnMonth = txnDate.getMonth();
                const txnYear = txnDate.getFullYear();
                
                return txnMonth === month && txnYear === year;
            });
            
            const total = invoiceTransactions.reduce((sum, t) => sum + t.value, 0);
            
            // Determine status
            const today = new Date();
            const closingDate = new Date(year, month, card.closingDay);
            const dueDate = new Date(year, month, card.dueDay);
            
            let status = 'open';
            if (today >= closingDate) {
                status = 'closed';
            }
            
            return {
                total,
                status,
                transactions: invoiceTransactions,
                dueDate,
                closingDate
            };
        }
        
        /**
         * Save transaction (Create or Update)
         * @param {Object} transactionData - Transaction details
         * @param {string} transactionId - Transaction ID (for updates, null for creates)
         * @param {boolean} isRecurring - Whether to create recurring transactions
         * @param {number} recurringMonths - Number of months to repeat
         * @returns {Promise<string>} Transaction ID or Group ID
         */
        async function saveTransaction(transactionData, transactionId = null, isRecurring = false, recurringMonths = 12) {
            try {
                // Validate user is logged in
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                // Validate data
                if (!transactionData.description || transactionData.description.length > 200) {
                    throw new Error('Descri√ß√£o inv√°lida (m√°x. 200 caracteres).');
                }
                
                if (!transactionData.value || transactionData.value <= 0) {
                    throw new Error('Valor deve ser maior que zero.');
                }
                
                if (!['receita', 'despesa'].includes(transactionData.type)) {
                    throw new Error('Tipo inv√°lido (receita ou despesa).');
                }
                
                /**
                 * Helper: Add months safely (handles leap years and month overflow)
                 * Example: 31/Jan + 1 month = 28/Feb (or 29/Feb if leap year)
                 */
                function addMonthsSafely(date, monthsToAdd) {
                    const d = new Date(date);
                    const originalDay = d.getDate();
                    d.setMonth(d.getMonth() + monthsToAdd);
                    
                    // If day changed due to overflow (e.g., 31 Jan -> 3 Mar), 
                    // set to last day of previous month
                    if (d.getDate() !== originalDay) {
                        d.setDate(0); // Go back to last day of previous month
                    }
                    
                    return d;
                }
                
                /**
                 * FASE 12.6: Motor de Cr√©dito BLINDADO
                 * Calcula a data de vencimento da fatura de compet√™ncia
                 * 
                 * @param {number} purchaseDate - Timestamp da compra
                 * @param {number} closingDay - Dia do fechamento (1-31)
                 * @param {number} dueDay - Dia do vencimento (1-31)
                 * @returns {number} Timestamp do vencimento da fatura
                 * 
                 * L√ìGICA DE COMPET√äNCIA:
                 * - Compra ANTES do fechamento (day < closingDay): Fatura do M√äS ATUAL
                 * - Compra A PARTIR do fechamento (day >= closingDay): Fatura do PR√ìXIMO M√äS
                 * 
                 * EXEMPLO:
                 * Compra: 04/12, Fechamento: dia 10, Vencimento: dia 15
                 * ‚Üí 4 < 10 ‚Üí Fatura de Dezembro ‚Üí Vence 15/12
                 * 
                 * Compra: 12/12, Fechamento: dia 10, Vencimento: dia 15
                 * ‚Üí 12 >= 10 ‚Üí Fatura de Janeiro ‚Üí Vence 15/01
                 */
                function calculateInvoiceDueDate(purchaseDate, closingDay, dueDay) {
                    const purchase = new Date(purchaseDate);
                    const purchaseDay = purchase.getDate();
                    
                    let invoiceMonth = purchase.getMonth();
                    let invoiceYear = purchase.getFullYear();
                    
                    // VIRADA DE FATURA: Compra >= Fechamento ‚Üí Pr√≥ximo M√™s
                    if (purchaseDay >= closingDay) {
                        invoiceMonth += 1;
                        if (invoiceMonth > 11) { // Virada de ano
                            invoiceMonth = 0;
                            invoiceYear += 1;
                        }
                    }
                    
                    // Data cont√°bil: Vencimento da fatura de compet√™ncia
                    const invoiceDue = new Date(invoiceYear, invoiceMonth, dueDay);
                    return invoiceDue.getTime();
                }
                
                if (transactionId) {
                    // UPDATE MODE (never recurring, just update single transaction)
                    const updates = {
                        value: Number(transactionData.value),
                        type: transactionData.type,
                        description: transactionData.description.trim(),
                        category: transactionData.category,
                        date: transactionData.date || Date.now(),
                        status: transactionData.status || 'confirmada'
                    };
                    
                    const txnRef = ref(database, `transactions/${transactionId}`);
                    await update(txnRef, updates);
                    
                    logger.log('‚úÖ Transa√ß√£o atualizada:', transactionId);
                    return transactionId;
                    
                } else if (transactionData.paymentMethod === 'credit' && transactionData.cardId) {
                    // CREATE MODE - CREDIT CARD WITH INSTALLMENTS (Banking Model)
                    const installments = transactionData.installments || 1;
                    const totalValue = Number(transactionData.value);
                    const installmentValue = totalValue / installments;
                    
                    // Get card data
                    const card = state.cards.find(c => c.id === transactionData.cardId);
                    if (!card) {
                        throw new Error('Cart√£o n√£o encontrado.');
                    }
                    
                    const groupId = crypto.randomUUID();
                    const transactionsRef = ref(database, 'transactions');
                    const purchaseDate = transactionData.date || Date.now();
                    
                    // Debug: Log purchase details
                    const purchaseDateObj = new Date(purchaseDate);
                    logger.log(`üí≥ Criando ${installments} parcelas no cart√£o ${card.name}...`);
                    logger.log(`üìÖ Data da compra: ${purchaseDateObj.toLocaleDateString('pt-BR')} (Dia ${purchaseDateObj.getDate()})`);
                    logger.log(`üìä Cart√£o - Fechamento: dia ${card.closingDay}, Vencimento: dia ${card.dueDay}`);
                    
                    // FASE 12.6: Calcular data de vencimento da primeira fatura
                    const firstDueDate = calculateInvoiceDueDate(purchaseDate, card.closingDay, card.dueDay);
                    const firstDueDateObj = new Date(firstDueDate);
                    
                    // Determine invoice competency month
                    const purchaseDay = purchaseDateObj.getDate();
                    const competencyMonth = purchaseDay >= card.closingDay ? 'pr√≥ximo m√™s' : 'm√™s atual';
                    logger.log(`üéØ Compet√™ncia: ${competencyMonth} (compra dia ${purchaseDay} ${purchaseDay >= card.closingDay ? '‚â•' : '<'} fechamento dia ${card.closingDay})`);
                    logger.log(`üí∞ Primeira fatura vence: ${firstDueDateObj.toLocaleDateString('pt-BR')} (Dia ${firstDueDateObj.getDate()})`);
                    
                    // Create installment transactions
                    for (let i = 0; i < installments; i++) {
                        // Each installment falls on the due day of subsequent months
                        const dueDate = addMonthsSafely(new Date(firstDueDate), i);
                        
                        // Debug: Log each installment date
                        if (i < 3 || i === installments - 1) { // Log first 3 and last
                            logger.log(`  üìå Parcela ${i + 1}/${installments}: Vence ${dueDate.toLocaleDateString('pt-BR')} (Dia ${dueDate.getDate()})`);
                        }
                        
                        const transaction = {
                            userId: auth.currentUser.uid,
                            value: Number(installmentValue.toFixed(2)),
                            type: transactionData.type,
                            description: `${transactionData.description.trim()} (${i + 1}/${installments})`,
                            category: transactionData.category,
                            date: dueDate.getTime(), // Data cont√°bil: vencimento da fatura
                            status: 'pendente', // Credit card installments start as pending
                            createdAt: Date.now(),
                            paymentMethod: 'credit',
                            cardId: transactionData.cardId,
                            groupId: groupId,
                            installment: {
                                current: i + 1,
                                total: installments
                            },
                            purchaseDate: purchaseDate // Store original purchase date
                        };
                        
                        await push(transactionsRef, transaction);
                    }
                    
                    logger.log(`‚úÖ ${installments} parcelas criadas no cart√£o com groupId: ${groupId}`);
                    return groupId;
                    
                } else if (isRecurring && recurringMonths > 1) {
                    // CREATE MODE - RECURRING TRANSACTIONS (Cash/Debit)
                    const groupId = crypto.randomUUID();
                    const transactionsRef = ref(database, 'transactions');
                    const baseDate = new Date(transactionData.date);
                    
                    logger.log(`üîÑ Criando ${recurringMonths} transa√ß√µes recorrentes...`);
                    
                    // Create multiple transactions
                    for (let i = 0; i < recurringMonths; i++) {
                        // Calculate date for this installment using safe month addition
                        const txnDate = addMonthsSafely(baseDate, i);
                        
                        const transaction = {
                            userId: auth.currentUser.uid,
                            value: Number(transactionData.value),
                            type: transactionData.type,
                            description: transactionData.description.trim(),
                            category: transactionData.category,
                            date: txnDate.getTime(),
                            status: transactionData.status || 'confirmada',
                            createdAt: Date.now(),
                            paymentMethod: transactionData.paymentMethod || 'cash',
                            groupId: groupId,
                            installment: {
                                current: i + 1,
                                total: recurringMonths
                            }
                        };
                        
                        await push(transactionsRef, transaction);
                    }
                    
                    logger.log(`‚úÖ ${recurringMonths} transa√ß√µes recorrentes criadas com groupId: ${groupId}`);
                    return groupId;
                    
                } else {
                    // CREATE MODE - SINGLE TRANSACTION (Cash/Debit)
                    const transaction = {
                        userId: auth.currentUser.uid, // CRITICAL for security rules
                        value: Number(transactionData.value),
                        type: transactionData.type,
                        description: transactionData.description.trim(),
                        category: transactionData.category,
                        date: transactionData.date || Date.now(),
                        status: transactionData.status || 'confirmada',
                        createdAt: Date.now(),
                        paymentMethod: transactionData.paymentMethod || 'cash'
                    };
                    
                    // Push to database (auto-generate ID)
                    const transactionsRef = ref(database, 'transactions');
                    const newTxnRef = await push(transactionsRef, transaction);
                    
                    logger.log('‚úÖ Transa√ß√£o criada:', newTxnRef.key);
                    return newTxnRef.key;
                }
                
            } catch (error) {
                logger.error('‚ùå Erro ao salvar transa√ß√£o:', error);
                throw error;
            }
        }
        
        /**
         * Legacy function for backward compatibility
         */
        async function addTransaction(transactionData) {
            return saveTransaction(transactionData, null);
        }

        /**
         * Delete a transaction from the database
         * @param {string} transactionId - Transaction ID
         * @returns {Promise<void>}
         */
        /**
         * FASE 13: Intelligent Transaction Deletion
         * Opens confirmation modal instead of deleting directly
         */
        let pendingDeletion = null; // Stores transaction data for deletion
        
        async function deleteTransaction(transactionId) {
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                // Fetch transaction data
                const txnRef = ref(database, `transactions/${transactionId}`);
                const snapshot = await get(txnRef);
                
                if (!snapshot.exists()) {
                    throw new Error('Transa√ß√£o n√£o encontrada.');
                }
                
                const txnData = snapshot.val();
                if (txnData.userId !== auth.currentUser.uid) {
                    throw new Error('Voc√™ n√£o tem permiss√£o para excluir esta transa√ß√£o.');
                }
                
                // Store for pending deletion
                pendingDeletion = {
                    id: transactionId,
                    data: txnData
                };
                
                // Show confirmation modal
                showDeleteConfirmationModal(txnData);
                
            } catch (error) {
                logger.error('‚ùå Erro ao preparar exclus√£o:', error);
                alert(error.message || 'Erro ao preparar exclus√£o.');
            }
        }

        /**
         * FASE 13: Show delete confirmation modal with transaction details
         */
        function showDeleteConfirmationModal(txnData) {
            const modal = ui.elements.modalDeleteConfirm;
            
            // Populate transaction info
            ui.elements.deleteTxnDescription.textContent = txnData.description;
            ui.elements.deleteTxnValue.textContent = formatCurrency(txnData.value);
            
            // Meta info
            const date = new Date(txnData.date);
            const categoryLabel = txnData.category ? ` ‚Ä¢ ${txnData.category}` : '';
            const installmentLabel = txnData.installment ? 
                ` ‚Ä¢ Parcela ${txnData.installment.current}/${txnData.installment.total}` : '';
            ui.elements.deleteTxnMeta.textContent = 
                `${date.toLocaleDateString('pt-BR')}${categoryLabel}${installmentLabel}`;
            
            // Determine if recurring/installment
            const isRecurring = txnData.groupId && txnData.installment;
            
            if (isRecurring) {
                // Show recurring options
                ui.elements.deleteMessageSingle.classList.add('hidden');
                ui.elements.deleteMessageRecurring.classList.remove('hidden');
                ui.elements.deleteActionsSingle.classList.add('hidden');
                ui.elements.deleteActionsRecurring.classList.remove('hidden');
            } else {
                // Show single transaction options
                ui.elements.deleteMessageSingle.classList.remove('hidden');
                ui.elements.deleteMessageRecurring.classList.add('hidden');
                ui.elements.deleteActionsSingle.classList.remove('hidden');
                ui.elements.deleteActionsRecurring.classList.add('hidden');
            }
            
            // Show modal
            modal.classList.remove('hidden');
        }

        /**
         * FASE 13: Hide delete confirmation modal
         */
        function hideDeleteConfirmationModal() {
            ui.elements.modalDeleteConfirm.classList.add('hidden');
            pendingDeletion = null;
        }

        /**
         * FASE 13: Execute deletion based on mode
         * @param {string} mode - 'single', 'this-only', or 'this-and-future'
         */
        async function executeDeletion(mode) {
            if (!pendingDeletion) {
                logger.error('‚ùå Nenhuma transa√ß√£o pendente para exclus√£o');
                return;
            }
            
            // Save pendingDeletion before hiding modal (which sets it to null)
            const { id, data } = pendingDeletion;
            
            try {
                ui.setLoading(true);
                hideDeleteConfirmationModal();
                
                if (mode === 'single' || mode === 'this-only') {
                    // Delete only this transaction
                    const txnRef = ref(database, `transactions/${id}`);
                    await remove(txnRef);
                    logger.log('‚úÖ Transa√ß√£o exclu√≠da:', id);
                    
                } else if (mode === 'this-and-future') {
                    // Delete this and all future installments
                    if (!data.groupId || !data.installment) {
                        throw new Error('Transa√ß√£o n√£o possui informa√ß√µes de parcelamento.');
                    }
                    
                    logger.log(`üîÑ Buscando parcelas do groupId: ${data.groupId}...`);
                    
                    // Query transactions filtered by userId (Firebase security compliance)
                    const userId = auth.currentUser.uid;
                    const q = query(
                        ref(database, 'transactions'),
                        orderByChild('userId'),
                        equalTo(userId)
                    );
                    const snapshot = await get(q);
                    
                    if (!snapshot.exists()) {
                        throw new Error('Nenhuma transa√ß√£o encontrada.');
                    }
                    
                    const allTransactions = snapshot.val();
                    const updates = {};
                    let deletedCount = 0;
                    
                    // Filter: same groupId AND current >= this transaction's current
                    Object.entries(allTransactions).forEach(([txnId, txn]) => {
                        if (
                            txn.groupId === data.groupId &&
                            txn.installment &&
                            txn.installment.current >= data.installment.current
                        ) {
                            updates[`/transactions/${txnId}`] = null;
                            deletedCount++;
                            logger.log(`  ‚ùå Removendo parcela ${txn.installment.current}/${txn.installment.total}`);
                        }
                    });
                    
                    // Atomic batch deletion
                    if (deletedCount > 0) {
                        await update(ref(database), updates);
                        logger.log(`‚úÖ ${deletedCount} parcelas exclu√≠das`);
                    }
                }
                
                ui.setLoading(false);
                
            } catch (error) {
                logger.error('‚ùå Erro ao executar exclus√£o:', error);
                alert(error.message || 'Erro ao excluir transa√ß√£o.');
                ui.setLoading(false);
            }
        }

        /**
         * Extend recurrence - Add 12 more months to a recurring transaction series
         * @param {string} groupId - The group ID of the recurring transaction
         * @param {string} lastTransactionId - The ID of the last transaction in the series
         * @returns {Promise<void>}
         */
        async function extendRecurrence(groupId, lastTransactionId) {
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }

                if (!confirm('Deseja prorrogar esta s√©rie de transa√ß√µes por mais 12 meses?')) {
                    return;
                }

                // Get the last transaction to use as template
                const txnRef = ref(database, `transactions/${lastTransactionId}`);
                const snapshot = await get(txnRef);
                
                if (!snapshot.exists()) {
                    throw new Error('Transa√ß√£o n√£o encontrada.');
                }
                
                const lastTxn = snapshot.val();
                
                if (lastTxn.userId !== auth.currentUser.uid) {
                    throw new Error('Voc√™ n√£o tem permiss√£o para prorrogar esta transa√ß√£o.');
                }

                // Create 12 new transactions starting from next month
                const transactionsRef = ref(database, 'transactions');
                const lastDate = new Date(lastTxn.date);
                
                logger.log(`üîÑ Prorrogando s√©rie ${groupId} por +12 meses...`);
                
                /**
                 * Helper: Add months safely (handles leap years and month overflow)
                 */
                function addMonthsSafely(date, monthsToAdd) {
                    const d = new Date(date);
                    const originalDay = d.getDate();
                    d.setMonth(d.getMonth() + monthsToAdd);
                    
                    if (d.getDate() !== originalDay) {
                        d.setDate(0); // Go back to last day of previous month
                    }
                    
                    return d;
                }
                
                for (let i = 1; i <= 12; i++) {
                    const txnDate = addMonthsSafely(lastDate, i);
                    
                    const newInstallmentNumber = lastTxn.installment.current + i;
                    
                    const transaction = {
                        userId: auth.currentUser.uid,
                        value: lastTxn.value,
                        type: lastTxn.type,
                        description: lastTxn.description,
                        category: lastTxn.category,
                        date: txnDate.getTime(),
                        status: lastTxn.status,
                        createdAt: Date.now(),
                        groupId: groupId,
                        installment: {
                            current: newInstallmentNumber,
                            total: lastTxn.installment.total + 12
                        }
                    };
                    
                    await push(transactionsRef, transaction);
                }

                // Update the total count in all transactions with this groupId
                const allTxnsRef = ref(database, 'transactions');
                const allTxnsSnapshot = await get(allTxnsRef);
                
                if (allTxnsSnapshot.exists()) {
                    const updates = {};
                    allTxnsSnapshot.forEach((childSnapshot) => {
                        const txn = childSnapshot.val();
                        if (txn.groupId === groupId) {
                            updates[`transactions/${childSnapshot.key}/installment/total`] = lastTxn.installment.total + 12;
                        }
                    });
                    
                    if (Object.keys(updates).length > 0) {
                        await update(ref(database), updates);
                    }
                }
                
                logger.log(`‚úÖ S√©rie ${groupId} prorrogada por +12 meses`);
                alert('‚úÖ Transa√ß√µes prorrogadas com sucesso!');
                
            } catch (error) {
                logger.error('‚ùå Erro ao prorrogar transa√ß√£o:', error);
                alert(error.message || 'Erro ao prorrogar transa√ß√£o.');
            }
        }

        /**
         * Get filtered and sorted transactions based on current state.filters
         * Does NOT mutate state.transactions
         * @returns {Array} Filtered and sorted transactions
         */
        function getFilteredTransactions() {
            let filtered = [...state.transactions];
            
            // FASE 15: Exclude faturadas (invoiced transactions) from Dashboard
            filtered = filtered.filter(txn => txn.status !== 'faturada');
            
            // Apply month/year filter (FIRST - most restrictive)
            const currentMonth = state.currentDate.getMonth();
            const currentYear = state.currentDate.getFullYear();
            
            filtered = filtered.filter(txn => {
                const txnDate = new Date(txn.date);
                return txnDate.getMonth() === currentMonth && 
                       txnDate.getFullYear() === currentYear;
            });
            
            // Apply type filter
            if (state.filters.type !== 'all') {
                filtered = filtered.filter(txn => txn.type === state.filters.type);
            }
            
            // Apply category filter
            if (state.filters.category) {
                filtered = filtered.filter(txn => txn.category === state.filters.category);
            }
            
            // Apply sorting
            switch (state.filters.sort) {
                case 'date_desc':
                    filtered.sort((a, b) => b.date - a.date);
                    break;
                case 'date_asc':
                    filtered.sort((a, b) => a.date - b.date);
                    break;
                case 'amount_desc':
                    filtered.sort((a, b) => b.value - a.value);
                    break;
                case 'amount_asc':
                    filtered.sort((a, b) => a.value - b.value);
                    break;
                default:
                    filtered.sort((a, b) => b.date - a.date);
            }
            
            return filtered;
        }

        /**
         * Toggle transaction status between 'pendente' and 'confirmada'
         * @param {string} transactionId - Transaction ID
         * @param {string} currentStatus - Current status
         */
        async function toggleTransactionStatus(transactionId, currentStatus) {
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                // Determine new status
                const newStatus = currentStatus === 'confirmada' ? 'pendente' : 'confirmada';
                
                // Update in Firebase
                const txnRef = ref(database, `transactions/${transactionId}/status`);
                await set(txnRef, newStatus);
                
                logger.log(`‚úÖ Status atualizado: ${transactionId} -> ${newStatus}`);
                
                // UI will auto-update via onValue listener
                
            } catch (error) {
                logger.error('‚ùå Erro ao atualizar status:', error);
                alert('Erro ao atualizar status da transa√ß√£o.');
            }
        }

        /**
         * Update active filter button styles
         * @param {string} filterType - 'all', 'receita', or 'despesa'
         */
        function updateFilterButtons(filterType) {
            const buttons = document.querySelectorAll('.filter-btn');
            
            buttons.forEach(btn => {
                const btnFilter = btn.dataset.filter;
                
                if (btnFilter === filterType) {
                    // Active state
                    if (filterType === 'receita') {
                        btn.className = 'filter-btn px-4 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl text-xs font-semibold shadow-md transition-all';
                    } else if (filterType === 'despesa') {
                        btn.className = 'filter-btn px-4 py-2 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-xl text-xs font-semibold shadow-md transition-all';
                    } else {
                        btn.className = 'filter-btn px-4 py-2 bg-gradient-to-r from-slate-700 to-slate-800 text-white rounded-xl text-xs font-semibold shadow-md transition-all';
                    }
                } else {
                    // Inactive state
                    btn.className = 'filter-btn px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-medium hover:border-slate-300 hover:text-slate-800 transition-all';
                }
            });
        }

        /**
         * Setup real-time listener for user's transactions
         * @returns {Function} Unsubscribe function
         */
        function setupTransactionListener() {
            if (!auth.currentUser) {
                logger.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado. Listener n√£o iniciado.');
                return;
            }
            
            // Clean up previous listener if exists
            if (listeners.transactions) {
                listeners.transactions();
                listeners.transactions = null;
            }
            
            const userId = auth.currentUser.uid;
            const transactionsRef = ref(database, 'transactions');
            
            // Query transactions filtered by userId on server-side
            const userTransactionsQuery = query(
                transactionsRef,
                orderByChild('userId'),
                equalTo(userId)
            );
            
            // Setup real-time listener with query and store unsubscribe function
            listeners.transactions = onValue(userTransactionsQuery, (snapshot) => {
                if (snapshot.exists()) {
                    const transactionsData = snapshot.val();
                    
                    // Convert object to array with IDs
                    const userTransactions = Object.entries(transactionsData)
                        .map(([id, txn]) => ({ id, ...txn }));
                    
                    logger.log('üìä Transa√ß√µes carregadas:', userTransactions.length);
                    
                    // Update state (keep original unfiltered data)
                    state.transactions = userTransactions;
                    
                    // Update UI with ALL transactions for cards (no filter)
                    ui.updateDashboardCards(userTransactions);
                    
                    // Render list with current filters applied
                    ui.renderTransactionList();
                    
                    // FASE 12.6: Render credit audit widget
                    ui.renderCreditAuditWidget();
                    
                    // Update category counts
                    ui.renderCategoryList();
                    
                    // Render charts
                    ui.renderCharts();
                    
                } else {
                    console.log('üì≠ Nenhuma transa√ß√£o encontrada');
                    state.transactions = [];
                    ui.updateDashboardCards([]);
                    ui.renderTransactionList();
                    ui.renderCreditAuditWidget();
                    ui.renderCategoryList();
                    ui.renderCharts();
                }
            }, (error) => {
                logger.error('‚ùå Erro no listener de transa√ß√µes:', error);
                logger.error('üí° Verifique as regras de seguran√ßa do Firebase.');
            });
        }

        /**
         * Setup listener for categories (global + personal)
         * @returns {Function} Unsubscribe function
         */
        function setupCategoryListener() {
            if (!auth.currentUser) {
                logger.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado. Listener de categorias n√£o iniciado.');
                return;
            }
            
            // Clean up previous listeners if exist
            if (listeners.categories) {
                listeners.categories();
                listeners.categories = null;
            }
            
            const userId = auth.currentUser.uid;
            
            // Listen to global categories
            const globalCategoriesRef = ref(database, 'categories/global');
            const unsubscribeGlobal = onValue(globalCategoriesRef, (snapshot) => {
                if (snapshot.exists()) {
                    state.categories.global = snapshot.val();
                    logger.log('üìÇ Categorias globais carregadas:', Object.keys(state.categories.global).length);
                } else {
                    state.categories.global = {};
                }
                updateCategoryDropdown();
                ui.renderCategoryList();
                // Re-render transactions to update category names
                ui.renderTransactionList();
                // Re-render charts to update category names
                ui.renderCharts();
            });
            
            // Listen to personal categories
            const personalCategoriesRef = ref(database, `categories/personal/${userId}`);
            const unsubscribePersonal = onValue(personalCategoriesRef, (snapshot) => {
                if (snapshot.exists()) {
                    state.categories.personal = snapshot.val();
                    logger.log('üìÇ Categorias pessoais carregadas:', Object.keys(state.categories.personal).length);
                } else {
                    state.categories.personal = {};
                }
                updateCategoryDropdown();
                ui.renderCategoryList();
                // Re-render transactions to update category names
                ui.renderTransactionList();
                // Re-render charts to update category names
                ui.renderCharts();
            });
            
            // Store combined unsubscribe function
            listeners.categories = () => {
                unsubscribeGlobal();
                unsubscribePersonal();
            };
        }

        /**
         * Update category dropdown with global + personal categories
         */
        /**
         * FASE 17: Update category dropdown with alphabetical sorting
         */
        function updateCategoryDropdown() {
            const select = document.getElementById('txn-category');
            if (!select) return;
            
            // Clear current options except first (default)
            select.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            // FASE 17: Combinar e ordenar categorias alfabeticamente
            const allCategories = [];
            
            // Adicionar categorias globais
            Object.entries(state.categories.global || {}).forEach(([key, cat]) => {
                allCategories.push({
                    key: key,
                    name: cat.name,
                    icon: cat.icon,
                    type: 'global'
                });
            });
            
            // Adicionar categorias pessoais
            Object.entries(state.categories.personal || {}).forEach(([key, cat]) => {
                allCategories.push({
                    key: key,
                    name: cat.name,
                    icon: cat.icon,
                    type: 'personal'
                });
            });
            
            // ORDENA√á√ÉO ALFAB√âTICA (pt-BR) - v2.0 - FOR√áAR ATUALIZA√á√ÉO
            allCategories.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            console.log('üî§ FASE 17: Categorias ordenadas alfabeticamente:', allCategories.map(c => c.name));
            
            // Renderizar options ordenadas
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.key;
                
                if (cat.type === 'personal') {
                    option.textContent = `${cat.icon} ${cat.name} (Pessoal)`;
                } else {
                    option.textContent = `${cat.icon} ${cat.name}`;
                }
                
                select.appendChild(option);
            });
            
            logger.log(`üìã Dropdown atualizado: ${allCategories.length} categorias ordenadas`);
        }

        /**
         * Add a new personal category
         * @param {string} name - Category name
         * @param {string} icon - Category emoji icon
         * @param {string} type - Category type (receita or despesa)
         * @returns {Promise<string>} Category ID
         */
        async function addCategory(name, icon, type) {
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                if (!name || name.length > 50) {
                    throw new Error('Nome inv√°lido (m√°x. 50 caracteres).');
                }
                
                if (!['receita', 'despesa'].includes(type)) {
                    throw new Error('Tipo inv√°lido (receita ou despesa).');
                }
                
                const userId = auth.currentUser.uid;
                const categoryData = {
                    name: name.trim(),
                    icon: icon || 'üìÅ',
                    type,
                    createdAt: Date.now()
                };
                
                // Generate key based on name (lowercase, no spaces)
                const categoryKey = name.toLowerCase().replace(/\s+/g, '_');
                
                // Save to personal categories
                const categoryRef = ref(database, `categories/personal/${userId}/${categoryKey}`);
                await set(categoryRef, categoryData);
                
                logger.log('‚úÖ Categoria criada:', categoryKey);
                return categoryKey;
                
            } catch (error) {
                logger.error('‚ùå Erro ao criar categoria:', error);
                throw error;
            }
        }

        /**
         * Open transaction for editing
         * @param {string} transactionId - Transaction ID
         */
        function openTransactionForEdit(transactionId) {
            const transaction = state.transactions.find(txn => txn.id === transactionId);
            
            if (!transaction) {
                logger.error('‚ùå Transa√ß√£o n√£o encontrada:', transactionId);
                return;
            }
            
            // Open modal in edit mode
            ui.showTransactionModal(transaction.type, transaction);
        }

        /**
         * Toggle category filter (global wrapper for onclick)
         * @param {string} categoryId - Category ID
         */
        function toggleCategoryFilter(categoryId) {
            ui.toggleCategoryFilter(categoryId);
        }

        /**
         * Navigate to cards view (global wrapper for onclick)
         */
        function navigateToCardsView() {
            ui.showView('cards');
        }

        /**
         * FASE 14: Select a card (global wrapper for onclick)
         */
        function selectCard(cardId) {
            state.selectedInvoice.cardId = cardId;
            ui.renderCardSelector();
            ui.renderInvoiceDetails();
        }

        /**
         * FASE 14: Pay Invoice
         * Create a payment transaction and mark invoice as paid
         */
        async function payInvoice(cardId, month, year) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) {
                alert('Cart√£o n√£o encontrado.');
                return;
            }
            
            const invoiceData = getInvoiceData(card, month, year);
            
            if (invoiceData.total === 0) {
                alert('Esta fatura n√£o possui valor a pagar.');
                return;
            }
            
            const confirmed = confirm(`Confirmar pagamento de ${formatCurrency(invoiceData.total)}?\n\nIsso criar√° uma despesa no fluxo de caixa e marcar√° a fatura como paga.`);
            if (!confirmed) return;
            
            try {
                ui.setLoading(true);
                
                const userId = auth.currentUser.uid;
                const paymentDate = Date.now();
                
                // 1. Create payment transaction (expense in cash flow)
                const txnRef = push(ref(database, 'transactions'));
                const paymentTransaction = {
                    userId,
                    value: invoiceData.total,
                    type: 'despesa',
                    description: `Pagamento Fatura ${card.name} - ${getMonthName(month)}/${year}`,
                    category: 'Pagamento de Cart√£o',
                    date: paymentDate,
                    status: 'confirmada',
                    createdAt: paymentDate,
                    paymentMethod: 'cash'
                };
                await set(txnRef, paymentTransaction);
                
                // 2. Save paid invoice record
                const invoiceKey = `${cardId}_${year}${String(month + 1).padStart(2, '0')}`;
                const invoiceRecord = {
                    status: 'paid',
                    amount: invoiceData.total,
                    paidAt: paymentDate,
                    transactionId: txnRef.key
                };
                await set(ref(database, `users/${userId}/invoices/${invoiceKey}`), invoiceRecord);
                
                // 3. FASE 15: Mark invoice transactions as 'faturada' (hide from Dashboard)
                const updates = {};
                invoiceData.transactions.forEach(txn => {
                    updates[`/transactions/${txn.id}/status`] = 'faturada';
                });
                
                if (Object.keys(updates).length > 0) {
                    await update(ref(database), updates);
                    logger.log(`üìã ${Object.keys(updates).length} transa√ß√µes marcadas como faturadas`);
                }
                
                logger.log(`‚úÖ Fatura paga: ${formatCurrency(invoiceData.total)}`);
                ui.setLoading(false);
                
                // Success feedback
                alert(`‚úÖ Fatura paga com sucesso!\n\nValor: ${formatCurrency(invoiceData.total)}\n\nAs transa√ß√µes do cart√£o foram ocultadas do Dashboard.`);
                
                // UI will update automatically via listeners
                
            } catch (error) {
                logger.error('‚ùå Erro ao pagar fatura:', error);
                
                // Detailed error message
                let errorMessage = 'Erro ao processar pagamento. Tente novamente.';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = 'Erro de permiss√£o no Firebase.\n\nVerifique se as regras de seguran√ßa est√£o atualizadas no Firebase Console.';
                }
                
                alert(`‚ùå ${errorMessage}`);
                ui.setLoading(false);
            }
        }

        /**
         * FASE 14.5: Restore Invoice (Undo Payment)
         * Delete the paid invoice record and the payment transaction
         * @param {string} cardId - Card ID
         * @param {number} month - Month (0-11)
         * @param {number} year - Year
         */
        async function restoreInvoice(cardId, month, year) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) {
                alert('Cart√£o n√£o encontrado.');
                return;
            }
            
            const invoiceKey = `${cardId}_${year}${String(month + 1).padStart(2, '0')}`;
            const invoiceRecord = state.invoices[invoiceKey];
            
            if (!invoiceRecord) {
                alert('Fatura n√£o encontrada.');
                return;
            }
            
            const confirmed = confirm(`‚ö†Ô∏è Restaurar fatura de ${formatCurrency(invoiceRecord.amount)}?\n\nIsso ir√°:\n‚Ä¢ Remover o registro de pagamento\n‚Ä¢ Excluir a despesa do fluxo de caixa\n‚Ä¢ Reabrir a fatura`);
            if (!confirmed) return;
            
            try {
                ui.setLoading(true);
                
                const userId = auth.currentUser.uid;
                
                // 1. Verify and delete payment transaction
                if (invoiceRecord.transactionId) {
                    const txnRef = ref(database, `transactions/${invoiceRecord.transactionId}`);
                    
                    // First, verify the transaction exists and belongs to the user
                    const txnSnapshot = await get(txnRef);
                    if (txnSnapshot.exists()) {
                        const txnData = txnSnapshot.val();
                        if (txnData.userId === userId) {
                            await remove(txnRef);
                            logger.log(`üóëÔ∏è Transa√ß√£o de pagamento exclu√≠da: ${invoiceRecord.transactionId}`);
                        } else {
                            throw new Error('Transa√ß√£o n√£o pertence ao usu√°rio autenticado.');
                        }
                    } else {
                        logger.warn('‚ö†Ô∏è Transa√ß√£o de pagamento n√£o encontrada (pode j√° ter sido exclu√≠da)');
                    }
                }
                
                // 2. Delete invoice record
                const invoiceRef = ref(database, `users/${userId}/invoices/${invoiceKey}`);
                await remove(invoiceRef);
                
                // 3. PHASE 15: Restore invoice transactions status back to 'confirmada'
                // Fetch transactions that belong to this invoice
                const invoiceData = await getInvoiceData(card, month, year);
                if (invoiceData && invoiceData.transactions && invoiceData.transactions.length > 0) {
                    const restoreUpdates = {};
                    invoiceData.transactions.forEach(txn => {
                        if (txn.status === 'faturada') {
                            restoreUpdates[`/transactions/${txn.id}/status`] = 'confirmada';
                        }
                    });
                    
                    if (Object.keys(restoreUpdates).length > 0) {
                        await update(ref(database), restoreUpdates);
                        logger.log(`üîÑ ${Object.keys(restoreUpdates).length} transa√ß√µes restauradas (faturada ‚Üí confirmada)`);
                    }
                }
                
                logger.log(`‚úÖ Fatura restaurada: ${formatCurrency(invoiceRecord.amount)}`);
                ui.setLoading(false);
                
                // Success feedback
                alert(`‚úÖ Fatura restaurada com sucesso!\n\nValor: ${formatCurrency(invoiceRecord.amount)}\n\nA fatura voltou ao status "Fechada" e a despesa foi removida do fluxo de caixa.\n\n${Object.keys(restoreUpdates || {}).length} compras voltaram ao Dashboard.`);
                
                // UI will update automatically via listeners
                
            } catch (error) {
                logger.error('‚ùå Erro ao restaurar fatura:', error);
                
                // Detailed error message
                let errorMessage = 'Erro ao restaurar fatura. Tente novamente.';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = 'Erro de permiss√£o no Firebase.\n\nVerifique se as regras de seguran√ßa est√£o atualizadas no Firebase Console.';
                }
                
                alert(`‚ùå ${errorMessage}`);
                ui.setLoading(false);
            }
        }

        /**
         * Helper: Get month name
         */
        function getMonthName(month) {
            const names = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                          'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return names[month];
        }

        /**
         * FASE 14.5: Open transaction modal with card pre-selected
         * @param {string} cardId - Card ID to pre-select
         */
        function openCardExpense(cardId) {
            // Open modal for expense
            ui.showTransactionModal('despesa');
            
            // Wait for modal to be fully rendered
            setTimeout(() => {
                // Set payment method to credit
                const paymentMethodSelect = ui.elements.txnPaymentMethod;
                if (paymentMethodSelect) {
                    paymentMethodSelect.value = 'credit';
                    
                    // Trigger change event to reveal card options
                    const changeEvent = new Event('change', { bubbles: true });
                    paymentMethodSelect.dispatchEvent(changeEvent);
                    
                    // Wait for card options to be revealed, then select card
                    setTimeout(() => {
                        const cardSelect = ui.elements.txnCard;
                        if (cardSelect) {
                            cardSelect.value = cardId;
                        }
                    }, 50);
                }
            }, 100);
        }

        // ============================================
        // FASE 19: DATA SAFETY & SETTINGS FUNCTIONS
        // ============================================

        /**
         * FASE 19: Initialize theme (ESTABILIZADO - For√ßando light mode)
         */
        function initializeTheme() {
            // CORRE√á√ÉO: For√ßa tema claro at√© dark mode estar completo
            // Remove qualquer tema salvo anteriormente que possa ter quebrado o layout
            localStorage.removeItem('theme');
            localStorage.setItem('theme', 'light');
            
            // For√ßa aplica√ß√£o do tema claro
            applyTheme('light');
            
            logger.log('üé® Tema inicializado: light (dark mode desabilitado temporariamente)');
            
            // Limpa tema no Firebase tamb√©m (se usu√°rio estiver logado)
            if (auth.currentUser) {
                const themeRef = ref(database, `users/${auth.currentUser.uid}/settings/theme`);
                set(themeRef, 'light').catch(err => {
                    logger.error('Erro ao for√ßar tema light no Firebase:', err);
                });
            }
        }

        /**
         * FASE 19: Apply theme to HTML element (ESTABILIZADO - Apenas Light Mode)
         */
        function applyTheme(theme) {
            // SEMPRE for√ßar light mode
            state.currentTheme = 'light';
            const html = document.documentElement;
            
            // GARANTIR que a classe dark NUNCA esteja presente
            html.classList.remove('dark');
            
            // UI sempre em modo light
            if (ui.elements.themeIcon) ui.elements.themeIcon.className = 'fas fa-moon text-slate-400';
            if (ui.elements.themeText) ui.elements.themeText.textContent = 'Tema Escuro';
            
            // Sempre salvar como light (ignora o par√¢metro)
            localStorage.setItem('theme', 'light');
            
            // Save to Firebase if user is logged in
            if (auth.currentUser) {
                const themeRef = ref(database, `users/${auth.currentUser.uid}/settings/theme`);
                set(themeRef, 'light').catch(err => {
                    logger.error('Erro ao salvar tema no Firebase:', err);
                });
            }
        }

        /**
         * FASE 19: Toggle theme (ESTABILIZADO - Dark mode em desenvolvimento)
         */
        function toggleTheme() {
            // Temporariamente desabilitado at√© implementar todas as classes dark: do Tailwind
            alert('üåô Tema Escuro em desenvolvimento!\n\nEm breve voc√™ poder√° alternar entre os modos claro e escuro.\n\nPor enquanto, o tema claro permanece ativo.');
            logger.log('üé® Toggle de tema solicitado (funcionalidade em desenvolvimento)');
            
            // For√ßa tema claro
            applyTheme('light');
        }

        /**
         * FASE 19: Create backup (The Guardian)
         */
        async function createBackup(type = 'manual') {
            if (!auth.currentUser) return;

            try {
                ui.setLoading(true);
                const userId = auth.currentUser.uid;
                const timestamp = Date.now();
                const backupId = `backup_${timestamp}`;

                logger.log(`üíæ Criando backup ${type}...`);

                // FASE 19.1: Pol√≠tica de Reten√ß√£o - Limpar backup autom√°tico antigo
                if (type === 'auto_reset') {
                    logger.log('üßπ Verificando backups auto_reset existentes...');
                    
                    // Buscar backups existentes
                    const backupsRef = ref(database, `users/${userId}/backups`);
                    const backupsSnap = await get(backupsRef);
                    
                    if (backupsSnap.exists()) {
                        const backups = backupsSnap.val();
                        
                        // Encontrar e deletar backups auto_reset antigos
                        for (const [oldBackupId, oldBackupData] of Object.entries(backups)) {
                            if (oldBackupData.metadata && oldBackupData.metadata.type === 'auto_reset') {
                                logger.log(`üóëÔ∏è Removendo backup auto_reset antigo: ${oldBackupId}`);
                                await set(ref(database, `users/${userId}/backups/${oldBackupId}`), null);
                            }
                        }
                    }
                }

                // FASE 19.2: Backup Universal - Buscar TODA a raiz do usu√°rio
                logger.log('üì¶ Capturando snapshot completo do usu√°rio...');
                const userRootRef = ref(database, `users/${userId}`);
                const userRootSnap = await get(userRootRef);

                if (!userRootSnap.exists()) {
                    throw new Error('Dados do usu√°rio n√£o encontrados');
                }

                // Obter todos os dados do usu√°rio
                const userData = userRootSnap.val();

                // FILTRAR: Remover chave 'backups' para evitar aninhamento
                const { backups: _, ...userDataFiltered } = userData;

                // Contar itens para metadata
                const itemCount = {
                    cards: Object.keys(userDataFiltered.cards || {}).length,
                    transactions: Object.keys(userDataFiltered.transactions || {}).length,
                    budgets: Object.keys(userDataFiltered.budgets || {}).length,
                    invoices: Object.keys(userDataFiltered.invoices || {}).length,
                    categories: Object.keys(userDataFiltered.categories || {}).length
                };

                // 2. Preparar payload do backup
                const backupPayload = {
                    metadata: {
                        timestamp: timestamp,
                        type: type,
                        version: '1.0',
                        createdAt: new Date(timestamp).toISOString(),
                        itemCount: itemCount
                    },
                    data: userDataFiltered // Objeto completo do usu√°rio (sem backups)
                };

                // 3. Salvar backup no Firebase
                const backupRef = ref(database, `users/${userId}/backups/${backupId}`);
                await set(backupRef, backupPayload);

                logger.log(`‚úÖ Backup universal criado: ${backupId}`);
                logger.log(`üìä Itens salvos:`, itemCount);
                ui.setLoading(false);

                if (type === 'manual') {
                    alert(`‚úÖ Backup criado com sucesso!\n\nID: ${backupId}\nData: ${new Date(timestamp).toLocaleString('pt-BR')}\n\nItens salvos:\n‚Ä¢ ${itemCount.cards} cart√µes\n‚Ä¢ ${itemCount.transactions} transa√ß√µes\n‚Ä¢ ${itemCount.invoices} faturas\n‚Ä¢ ${itemCount.budgets} or√ßamentos`);
                }

                return backupId;

            } catch (error) {
                logger.error('‚ùå Erro ao criar backup:', error);
                ui.setLoading(false);
                alert('‚ùå Erro ao criar backup. Tente novamente.');
                return null;
            }
        }

        /**
         * FASE 19: Reset all data (The Guardian - NEVER deletes without backup)
         */
        async function resetAllData() {
            if (!auth.currentUser) return;

            const confirmed = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: Resetar Todos os Dados\n\n' +
                'Esta a√ß√£o ir√°:\n' +
                '‚Ä¢ Criar um backup autom√°tico de seguran√ßa\n' +
                '‚Ä¢ Excluir TODAS as transa√ß√µes\n' +
                '‚Ä¢ Excluir TODOS os cart√µes\n' +
                '‚Ä¢ Excluir TODOS os or√ßamentos\n' +
                '‚Ä¢ Excluir TODAS as faturas\n\n' +
                'Voc√™ poder√° restaurar os dados a partir do backup.\n\n' +
                'Deseja continuar?'
            );

            if (!confirmed) return;

            try {
                ui.setLoading(true);
                const userId = auth.currentUser.uid;

                // RULE OF GOLD: Create backup FIRST
                logger.log('üõ°Ô∏è GUARDI√ÉO: Criando backup de seguran√ßa antes do reset...');
                const backupId = await createBackup('auto_reset');

                if (!backupId) {
                    throw new Error('Falha ao criar backup de seguran√ßa. Reset cancelado.');
                }

                // Wait a moment to ensure backup is saved
                await new Promise(resolve => setTimeout(resolve, 1000));

                logger.log('üóëÔ∏è Backup confirmado. Iniciando reset...');

                // 2. Delete all data nodes (CORRIGIDO: incluindo cards)
                const updates = {};
                
                // Delete user's transactions (global node)
                const transactionsSnap = await get(query(ref(database, 'transactions'), orderByChild('userId'), equalTo(userId)));
                if (transactionsSnap.exists()) {
                    transactionsSnap.forEach(child => {
                        updates[`/transactions/${child.key}`] = null;
                    });
                    logger.log(`üóëÔ∏è ${Object.keys(transactionsSnap.val()).length} transa√ß√µes marcadas para exclus√£o`);
                }

                // Delete user's cards (global node)
                const cardsSnap = await get(query(ref(database, 'cards'), orderByChild('userId'), equalTo(userId)));
                if (cardsSnap.exists()) {
                    cardsSnap.forEach(child => {
                        updates[`/cards/${child.key}`] = null;
                    });
                    logger.log(`üóëÔ∏è ${Object.keys(cardsSnap.val()).length} cart√µes marcados para exclus√£o`);
                }

                // Delete user-specific nodes
                updates[`/users/${userId}/budgets`] = null;
                updates[`/users/${userId}/invoices`] = null;
                updates[`/users/${userId}/categories`] = null;
                updates[`/users/${userId}/cards`] = null; // CORRE√á√ÉO: Tamb√©m limpar cards do n√≥ do usu√°rio
                
                logger.log('üóëÔ∏è Total de updates:', Object.keys(updates).length);

                // Apply all deletions atomically
                await update(ref(database), updates);
                
                logger.log('‚úÖ Todos os dados foram exclu√≠dos do Firebase');

                // CORRE√á√ÉO: Limpar estado local para evitar cache
                state.transactions = [];
                state.cards = [];
                state.budgets = {};
                state.invoices = {};
                state.categories.personal = {};
                
                logger.log('‚úÖ Estado local limpo');

                logger.log('‚úÖ Reset conclu√≠do com sucesso');
                ui.setLoading(false);

                alert(
                    `‚úÖ Dados resetados com sucesso!\n\n` +
                    `üõ°Ô∏è Um backup de seguran√ßa foi criado automaticamente:\n` +
                    `ID: ${backupId}\n\n` +
                    `Voc√™ pode restaurar seus dados a qualquer momento atrav√©s das Configura√ß√µes > Dados & Seguran√ßa.`
                );

                // Reload page to refresh UI
                location.reload();

            } catch (error) {
                logger.error('‚ùå Erro ao resetar dados:', error);
                ui.setLoading(false);
                alert(`‚ùå Erro ao resetar dados: ${error.message}\n\nSeus dados est√£o seguros e n√£o foram alterados.`);
            }
        }

        /**
         * FASE 19: Restore backup
         */
        async function restoreBackup(backupId) {
            if (!auth.currentUser) return;

            const confirmed = confirm(
                `‚ö†Ô∏è Restaurar Backup?\n\n` +
                `Backup ID: ${backupId}\n\n` +
                `Esta a√ß√£o ir√°:\n` +
                `‚Ä¢ Sobrescrever TODOS os dados atuais\n` +
                `‚Ä¢ Restaurar TUDO do backup (cart√µes, transa√ß√µes, faturas, or√ßamentos)\n\n` +
                `Um backup autom√°tico dos dados atuais ser√° criado antes da restaura√ß√£o.\n\n` +
                `Deseja continuar?`
            );

            if (!confirmed) return;

            try {
                ui.setLoading(true);
                const userId = auth.currentUser.uid;

                // 1. Criar backup dos dados atuais (seguran√ßa)
                logger.log('üíæ Criando backup de seguran√ßa dos dados atuais...');
                await createBackup('pre_restore');

                // 2. Buscar backup selecionado
                logger.log(`üì¶ Carregando backup ${backupId}...`);
                const backupRef = ref(database, `users/${userId}/backups/${backupId}`);
                const backupSnap = await get(backupRef);

                if (!backupSnap.exists()) {
                    throw new Error('Backup n√£o encontrado');
                }

                const backupPayload = backupSnap.val();

                // Validar estrutura do backup
                if (!backupPayload.data) {
                    throw new Error('Backup com estrutura inv√°lida (sem propriedade .data)');
                }

                const restoredData = backupPayload.data;
                const metadata = backupPayload.metadata || {};

                logger.log('üìä Dados a restaurar:', {
                    cards: Object.keys(restoredData.cards || {}).length,
                    transactions: Object.keys(restoredData.transactions || {}).length,
                    invoices: Object.keys(restoredData.invoices || {}).length,
                    budgets: Object.keys(restoredData.budgets || {}).length
                });

                // 3. LIMPEZA COMPLETA - Deletar TODOS os n√≥s de dados do usu√°rio
                logger.log('üóëÔ∏è Limpando TODOS os dados atuais...');
                const clearUpdates = {};

                // Limpar n√≥s principais do usu√°rio (exceto backups)
                clearUpdates[`/users/${userId}/cards`] = null;
                clearUpdates[`/users/${userId}/transactions`] = null;
                clearUpdates[`/users/${userId}/budgets`] = null;
                clearUpdates[`/users/${userId}/invoices`] = null;
                clearUpdates[`/users/${userId}/categories`] = null;
                clearUpdates[`/users/${userId}/settings`] = null;

                await update(ref(database), clearUpdates);
                logger.log('‚úÖ Limpeza conclu√≠da');

                // 4. RESTAURA√á√ÉO - Escrever dados do backup na raiz do usu√°rio
                logger.log('‚ôªÔ∏è Restaurando dados do backup...');
                const userRootRef = ref(database, `users/${userId}`);
                
                // Usar update para escrever todos os dados de uma vez
                await update(userRootRef, restoredData);

                logger.log('‚úÖ Backup restaurado com sucesso');
                logger.log('üîÑ Recarregando p√°gina para limpar cache...');
                ui.setLoading(false);

                alert(
                    `‚úÖ Backup restaurado com sucesso!\n\n` +
                    `A p√°gina ser√° recarregada para aplicar as altera√ß√µes.`
                );

                // Reload page
                location.reload();

            } catch (error) {
                logger.error('‚ùå Erro ao restaurar backup:', error);
                ui.setLoading(false);
                alert(`‚ùå Erro ao restaurar backup: ${error.message}`);
            }
        }

        /**
         * FASE 19.1: Delete backup with minimum retention policy
         */
        async function deleteBackup(backupId) {
            if (!auth.currentUser) return;

            try {
                const userId = auth.currentUser.uid;

                // FASE 19.1: Trava de Seguran√ßa - Minimum Retention
                const totalBackups = Object.keys(state.backups).length;
                
                if (totalBackups <= 1) {
                    alert('‚ö†Ô∏è Seguran√ßa de Dados\n\nPor seguran√ßa, voc√™ deve manter pelo menos um backup.\n\nCrie um novo backup antes de excluir este.');
                    logger.log('üõ°Ô∏è Exclus√£o bloqueada: m√≠nimo de 1 backup deve ser mantido');
                    return;
                }

                // Confirmar exclus√£o
                const backupData = state.backups[backupId];
                const date = new Date(backupData.metadata.createdAt);
                const confirmed = confirm(
                    `üóëÔ∏è Excluir Backup?\n\n` +
                    `Data: ${date.toLocaleString('pt-BR')}\n` +
                    `Tipo: ${backupData.metadata.type}\n\n` +
                    `Esta a√ß√£o n√£o pode ser desfeita.\n\n` +
                    `Deseja continuar?`
                );

                if (!confirmed) return;

                ui.setLoading(true);
                logger.log(`üóëÔ∏è Excluindo backup: ${backupId}`);

                // Delete backup from Firebase
                const backupRef = ref(database, `users/${userId}/backups/${backupId}`);
                await set(backupRef, null);

                logger.log('‚úÖ Backup exclu√≠do com sucesso');
                ui.setLoading(false);

                // UI will update automatically via listener

            } catch (error) {
                logger.error('‚ùå Erro ao excluir backup:', error);
                ui.setLoading(false);
                alert('‚ùå Erro ao excluir backup. Tente novamente.');
            }
        }

        /**
         * FASE 19.1: Render backup list with delete button
         */
        function renderBackupList() {
            const container = ui.elements.backupList;
            if (!container) return;

            const backups = Object.entries(state.backups)
                .sort((a, b) => b[1].metadata.createdAt - a[1].metadata.createdAt);

            if (backups.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500 text-sm">
                        <i class="fas fa-folder-open text-3xl mb-2 opacity-50"></i>
                        <p>Nenhum backup dispon√≠vel</p>
                    </div>
                `;
                return;
            }

            const totalBackups = backups.length;

            container.innerHTML = backups.map(([backupId, data]) => {
                const date = new Date(data.metadata.createdAt);
                const typeLabels = {
                    manual: 'üíæ Manual',
                    auto_reset: 'üîÑ Auto (Reset)',
                    pre_restore: 'üîô Auto (Pr√©-restaura√ß√£o)'
                };
                const typeLabel = typeLabels[data.metadata.type] || 'üíæ Manual';
                const itemCount = data.metadata.itemCount;

                return `
                    <div class="p-3 bg-white border border-slate-200 rounded-xl hover:shadow-md transition-all">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-slate-800">
                                    ${typeLabel}
                                </p>
                                <p class="text-xs text-slate-500 mt-0.5">
                                    <i class="fas fa-clock mr-1"></i>${date.toLocaleString('pt-BR')}
                                </p>
                                <p class="text-xs text-slate-600 mt-1">
                                    ${itemCount.transactions} transa√ß√µes ‚Ä¢ ${itemCount.cards} cart√µes
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button 
                                    onclick="restoreBackup('${backupId}')"
                                    class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs font-semibold rounded-lg hover:shadow-lg transition-all"
                                    title="Restaurar este backup"
                                >
                                    <i class="fas fa-undo mr-1"></i>Restaurar
                                </button>
                                <button 
                                    onclick="deleteBackup('${backupId}')"
                                    class="px-3 py-1.5 ${totalBackups <= 1 ? 'bg-slate-300 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600 hover:shadow-lg'} text-white text-xs font-semibold rounded-lg transition-all"
                                    title="${totalBackups <= 1 ? 'Mantenha pelo menos 1 backup' : 'Excluir este backup'}"
                                    ${totalBackups <= 1 ? 'disabled' : ''}
                                >
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Make functions globally accessible for onclick handlers
        window.deleteTransaction = deleteTransaction;
        window.toggleTransactionStatus = toggleTransactionStatus;
        window.openTransactionForEdit = openTransactionForEdit;
        window.toggleCategoryFilter = toggleCategoryFilter;
        window.navigateToCardsView = navigateToCardsView;
        window.selectCard = selectCard;
        window.payInvoice = payInvoice;
        window.restoreInvoice = restoreInvoice;
        window.openCardExpense = openCardExpense;
        window.restoreBackup = restoreBackup;
        window.deleteBackup = deleteBackup;

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // Tab switching
        ui.elements.tabLogin.addEventListener('click', () => ui.toggleAuthForm('login'));
        ui.elements.tabRegister.addEventListener('click', () => ui.toggleAuthForm('register'));

        // Transaction filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filterType = e.currentTarget.dataset.filter;
                
                // Update state
                state.filters.type = filterType;
                
                // If clicking "Todas", also clear category filter (Global Reset)
                if (filterType === 'all') {
                    state.filters.category = null;
                    ui.renderCategoryList(); // Update sidebar highlight
                }
                
                // Update button styles
                updateFilterButtons(filterType);
                
                // Re-render list with new filter
                ui.renderTransactionList();
                
                logger.log(`üîç Filtro aplicado: ${filterType}`);
            });
        });

        // Login form submission
        ui.elements.formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            // Basic validation
            if (!email || !password) {
                ui.showAuthMessage('Preencha todos os campos.', 'error');
                return;
            }
            
            try {
                ui.setLoading(true);
                ui.elements.authMessage.classList.add('hidden');
                
                await loginUser(email, password);
                
                // Clear form
                e.target.reset();
                
            } catch (error) {
                ui.showAuthMessage(error.message, 'error');
                ui.setLoading(false);
            }
        });

        // Register form submission
        ui.elements.formRegister.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            
            // Basic validation
            if (!name || !email || !password) {
                ui.showAuthMessage('Preencha todos os campos.', 'error');
                return;
            }
            
            if (name.length < 3) {
                ui.showAuthMessage('Nome deve ter pelo menos 3 caracteres.', 'error');
                return;
            }
            
            if (password.length < 6) {
                ui.showAuthMessage('Senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            try {
                ui.setLoading(true);
                ui.elements.authMessage.classList.add('hidden');
                
                await registerUser(email, password, name);
                
                // Clear form
                e.target.reset();
                
            } catch (error) {
                ui.showAuthMessage(error.message, 'error');
                ui.setLoading(false);
            }
        });

        // Logout button
        ui.elements.btnLogout.addEventListener('click', async () => {
            try {
                ui.setLoading(true);
                await logoutUser();
            } catch (error) {
                logger.error('Erro ao sair:', error);
                alert('Erro ao sair. Tente novamente.');
                ui.setLoading(false);
            }
        });

        // FASE 19: Settings & Theme controls
        ui.elements.btnOpenSettings.addEventListener('click', () => {
            ui.elements.modalSettings.classList.remove('hidden');
            ui.elements.userMenuDropdown.classList.add('hidden');
            
            // Load current user data
            if (auth.currentUser) {
                ui.elements.settingsEmail.value = auth.currentUser.email || '';
                ui.elements.settingsDisplayName.value = auth.currentUser.displayName || '';
            }
            
            // Render backup list
            renderBackupList();
        });

        ui.elements.btnCloseSettings.addEventListener('click', () => {
            ui.elements.modalSettings.classList.add('hidden');
        });

        ui.elements.btnToggleTheme.addEventListener('click', () => {
            toggleTheme();
            ui.elements.userMenuDropdown.classList.add('hidden');
        });

        ui.elements.btnSaveDisplayName.addEventListener('click', async () => {
            const newName = ui.elements.settingsDisplayName.value.trim();
            if (!newName) {
                alert('Por favor, insira um nome v√°lido');
                return;
            }

            try {
                ui.setLoading(true);
                await updateProfile(auth.currentUser, { displayName: newName });
                
                // Update UI
                document.getElementById('user-name').textContent = newName;
                const initials = newName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('user-avatar').textContent = initials;

                ui.setLoading(false);
                alert('‚úÖ Nome atualizado com sucesso!');
            } catch (error) {
                logger.error('Erro ao atualizar nome:', error);
                ui.setLoading(false);
                alert('‚ùå Erro ao atualizar nome. Tente novamente.');
            }
        });

        // Settings tabs
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.settings-tab').forEach(t => {
                    t.classList.remove('border-blue-600', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-slate-500');
                });
                tab.classList.remove('border-transparent', 'text-slate-500');
                tab.classList.add('border-blue-600', 'text-blue-600');
                
                // Show corresponding content
                document.querySelectorAll('.settings-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`content-${tabName}`).classList.remove('hidden');
            });
        });

        ui.elements.btnCreateBackup.addEventListener('click', async () => {
            await createBackup('manual');
        });

        ui.elements.btnResetAll.addEventListener('click', async () => {
            await resetAllData();
        });

        // Close settings modal when clicking outside
        ui.elements.modalSettings.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalSettings) {
                ui.elements.modalSettings.classList.add('hidden');
            }
        });

        // User menu dropdown toggle
        ui.elements.userMenuButton.addEventListener('click', () => {
            ui.elements.userMenuDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!ui.elements.userMenuButton.contains(e.target) && 
                !ui.elements.userMenuDropdown.contains(e.target)) {
                ui.elements.userMenuDropdown.classList.add('hidden');
            }
        });

        // Transaction modal controls
        ui.elements.btnNewTransaction.addEventListener('click', () => {
            ui.showTransactionModal('receita');
        });

        ui.elements.btnQuickIncome.addEventListener('click', () => {
            ui.showTransactionModal('receita');
        });

        ui.elements.btnQuickExpense.addEventListener('click', () => {
            ui.showTransactionModal('despesa');
        });

        ui.elements.btnCloseModal.addEventListener('click', () => {
            ui.hideTransactionModal();
        });

        ui.elements.btnCancelTransaction.addEventListener('click', () => {
            ui.hideTransactionModal();
        });

        // Close modal on background click
        ui.elements.modalTransaction.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalTransaction) {
                ui.hideTransactionModal();
            }
        });

        // Category modal controls (kept for potential future use)
        ui.elements.btnCloseCategoryModal.addEventListener('click', () => {
            ui.hideCategoryModal();
        });

        ui.elements.btnCancelCategory.addEventListener('click', () => {
            ui.hideCategoryModal();
        });

        // Close category modal on background click
        ui.elements.modalCategory.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalCategory) {
                ui.hideCategoryModal();
            }
        });

        // Budget modal controls (kept for potential future use)
        ui.elements.btnCloseBudgetModal.addEventListener('click', () => {
            ui.elements.modalBudget.classList.add('hidden');
        });

        ui.elements.btnCancelBudget.addEventListener('click', () => {
            ui.elements.modalBudget.classList.add('hidden');
        });

        ui.elements.btnSaveBudgets.addEventListener('click', () => {
            saveBudgets();
        });

        // Close budget modal on background click
        ui.elements.modalBudget.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalBudget) {
                ui.elements.modalBudget.classList.add('hidden');
            }
        });

        // FASE 13: Delete Confirmation Modal controls
        ui.elements.btnCloseDeleteModal.addEventListener('click', () => {
            hideDeleteConfirmationModal();
        });

        ui.elements.btnCancelDelete.addEventListener('click', () => {
            hideDeleteConfirmationModal();
        });

        ui.elements.btnCancelDeleteRecurring.addEventListener('click', () => {
            hideDeleteConfirmationModal();
        });

        ui.elements.btnDeleteSingleConfirm.addEventListener('click', () => {
            executeDeletion('single');
        });

        ui.elements.btnDeleteThisOnly.addEventListener('click', () => {
            executeDeletion('this-only');
        });

        ui.elements.btnDeleteThisAndFuture.addEventListener('click', () => {
            executeDeletion('this-and-future');
        });

        // Close delete modal on background click
        ui.elements.modalDeleteConfirm.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalDeleteConfirm) {
                hideDeleteConfirmationModal();
            }
        });

        // Export & Print controls
        document.getElementById('btn-export-csv').addEventListener('click', () => {
            exportToCSV();
        });

        document.getElementById('btn-print-report').addEventListener('click', () => {
            printReport();
        });

        // Month navigation controls
        ui.elements.btnPrevMonth.addEventListener('click', () => {
            ui.prevMonth();
        });

        ui.elements.btnNextMonth.addEventListener('click', () => {
            ui.nextMonth();
        });

        ui.elements.btnToday.addEventListener('click', () => {
            ui.goToToday();
        });

        // FASE 14.7: Temporal navigation controls (Cards view)
        ui.elements.btnPrevCardMonth.addEventListener('click', () => {
            ui.prevCardMonth();
        });

        ui.elements.btnNextCardMonth.addEventListener('click', () => {
            ui.nextCardMonth();
        });

        ui.elements.btnResetCardMonth.addEventListener('click', () => {
            ui.resetCardMonth();
        });

        // Payment method controls
        ui.elements.txnPaymentMethod.addEventListener('change', (e) => {
            const isCreditCard = e.target.value === 'credit';
            ui.elements.creditCardOptions.classList.toggle('hidden', !isCreditCard);
            
            // Disable recurring if credit card is selected
            if (isCreditCard) {
                ui.elements.txnRecurring.checked = false;
                ui.elements.recurringOptions.classList.add('hidden');
                ui.elements.txnRecurring.disabled = true;
            } else {
                ui.elements.txnRecurring.disabled = false;
            }
            
            // Populate card select
            if (isCreditCard) {
                populateCardSelect();
            }
        });

        // Installments and value change - calculate installment amount
        function updateInstallmentValue() {
            const totalValue = parseFloat(document.getElementById('txn-value').value) || 0;
            const installments = parseInt(ui.elements.txnInstallments.value) || 1;
            const installmentValue = totalValue / installments;
            
            ui.elements.installmentValue.textContent = formatCurrency(installmentValue);
        }

        ui.elements.txnInstallments.addEventListener('input', updateInstallmentValue);
        document.getElementById('txn-value').addEventListener('input', updateInstallmentValue);

        /**
         * Populate card select with user's cards
         */
        function populateCardSelect() {
            const select = ui.elements.txnCard;
            select.innerHTML = '<option value="">Selecione um cart√£o...</option>';
            
            state.cards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.id;
                option.textContent = `${card.name} - Limite: ${formatCurrency(card.limit)}`;
                select.appendChild(option);
            });
        }

        // Recurrence controls
        ui.elements.txnRecurring.addEventListener('change', (e) => {
            if (e.target.checked) {
                ui.elements.recurringOptions.classList.remove('hidden');
                updateRecurringEndDate();
            } else {
                ui.elements.recurringOptions.classList.add('hidden');
            }
        });

        ui.elements.txnRecurringMonths.addEventListener('input', () => {
            updateRecurringEndDate();
        });

        /**
         * Update recurring end date display
         */
        function updateRecurringEndDate() {
            const dateInput = document.getElementById('txn-date').value;
            const months = parseInt(ui.elements.txnRecurringMonths.value) || 12;
            
            if (dateInput) {
                const startDate = new Date(dateInput);
                const endDate = new Date(startDate);
                endDate.setMonth(startDate.getMonth() + months - 1);
                
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const endMonth = monthNames[endDate.getMonth()];
                const endYear = endDate.getFullYear();
                
                ui.elements.recurringEndDate.textContent = `${endMonth}/${endYear}`;
            }
        }

        // Icon selection
        document.querySelectorAll('.icon-selector').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const icon = e.currentTarget.dataset.icon;
                
                // Update hidden input and display
                document.getElementById('cat-icon').value = icon;
                document.getElementById('selected-icon').textContent = icon;
                
                // Update button styles
                document.querySelectorAll('.icon-selector').forEach(b => {
                    b.classList.remove('bg-emerald-100', 'ring-2', 'ring-emerald-500');
                });
                e.currentTarget.classList.add('bg-emerald-100', 'ring-2', 'ring-emerald-500');
            });
        });

        // Category form submission
        ui.elements.formCategory.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('cat-name').value.trim();
            const icon = document.getElementById('cat-icon').value;
            const formData = new FormData(e.target);
            const type = formData.get('cat-type');
            
            try {
                ui.setLoading(true);
                ui.elements.categoryModalMessage.classList.add('hidden');
                
                await addCategory(name, icon, type);
                
                // Success
                ui.hideCategoryModal();
                ui.setLoading(false);
                ui.showCategoryModalMessage('Categoria criada com sucesso!', 'success');
                
            } catch (error) {
                ui.showCategoryModalMessage(error.message, 'error');
                ui.setLoading(false);
            }
        });

        // ============================================
        // BUDGET MANAGEMENT
        // ============================================

        function renderBudgetList(searchTerm = '') {
            const budgetList = ui.elements.budgetList;
            budgetList.innerHTML = '';
            
            // Combine all categories
            const allCategories = { ...state.categories.global, ...state.categories.personal };
            
            // Filter categories by search term
            const filteredCategories = Object.entries(allCategories).filter(([catId, catData]) => {
                if (!searchTerm) return true;
                return catData.name.toLowerCase().includes(searchTerm.toLowerCase());
            });
            
            if (filteredCategories.length === 0) {
                budgetList.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <i class="fas fa-search text-3xl mb-2"></i>
                        <p>Nenhuma categoria encontrada</p>
                    </div>
                `;
                return;
            }
            
            // Create input row for each category
            filteredCategories.forEach(([catId, catData]) => {
                const currentBudget = state.budgets[catId] || '';
                const emoji = catData.icon || catData.emoji || 'üìÅ';
                
                const row = document.createElement('div');
                row.className = 'flex items-center gap-4 p-3 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl';
                row.innerHTML = `
                    <span class="text-2xl">${emoji}</span>
                    <span class="flex-1 font-medium text-slate-700">${catData.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-500 text-sm">R$</span>
                        <input 
                            type="number" 
                            step="0.01" 
                            min="0" 
                            placeholder="0,00"
                            value="${currentBudget}"
                            data-category="${catId}"
                            data-category-name="${catData.name}"
                            class="w-32 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-right"
                        />
                    </div>
                `;
                budgetList.appendChild(row);
            });
        }

        function openBudgetModal() {
            renderBudgetList();
            
            // Setup search functionality
            const searchInput = document.getElementById('budget-search');
            searchInput.value = '';
            searchInput.addEventListener('input', (e) => {
                renderBudgetList(e.target.value);
            });
            
            ui.elements.modalBudget.classList.remove('hidden');
            searchInput.focus();
        }

        async function saveBudgets() {
            if (!state.user) return;
            
            // Clear search to show all categories before saving
            const searchInput = document.getElementById('budget-search');
            const currentSearch = searchInput.value;
            searchInput.value = '';
            renderBudgetList('');
            
            // Wait for render to complete
            await new Promise(resolve => setTimeout(resolve, 50));
            
            const inputs = ui.elements.budgetList.querySelectorAll('input[data-category]');
            const budgets = {};
            
            inputs.forEach(input => {
                const categoryId = input.dataset.category;
                const value = parseFloat(input.value);
                
                if (value > 0) {
                    budgets[categoryId] = value;
                }
            });
            
            try {
                ui.setLoading(true);
                
                // Save to Firebase
                const budgetRef = ref(database, `users/${state.user.uid}/budgets`);
                await set(budgetRef, budgets);
                
                // Update local state
                state.budgets = budgets;
                
                // Re-render category list with progress bars
                ui.renderCategoryList();
                
                ui.elements.modalBudget.classList.add('hidden');
                ui.setLoading(false);
                
            } catch (error) {
                logger.error('Erro ao salvar or√ßamentos:', error);
                alert('Erro ao salvar or√ßamentos. Tente novamente.');
                ui.setLoading(false);
            }
        }

        function setupBudgetListener(userId) {
            if (!auth.currentUser) {
                logger.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado. Budget listener n√£o iniciado.');
                return;
            }
            
            // Clean up previous listener if exists
            if (listeners.budgets) {
                listeners.budgets();
                listeners.budgets = null;
            }
            
            const budgetRef = ref(database, `users/${userId}/budgets`);
            
            listeners.budgets = onValue(budgetRef, (snapshot) => {
                state.budgets = snapshot.val() || {};
                logger.log('üí∞ Or√ßamentos carregados:', Object.keys(state.budgets).length);
                ui.renderCategoryList();
            });
        }

        // ============================================
        // EXPORT & REPORTING
        // ============================================

        function exportToCSV() {
            if (state.transactions.length === 0) {
                alert('N√£o h√° transa√ß√µes para exportar.');
                return;
            }
            
            // Combine all categories for lookup
            const allCategories = { ...state.categories.global, ...state.categories.personal };
            
            // CSV Headers
            const headers = ['Data', 'Descri√ß√£o', 'Categoria', 'Tipo', 'Valor', 'Status'];
            
            // Convert transactions to CSV rows
            const rows = state.transactions.map(txn => {
                const date = new Date(txn.date).toLocaleDateString('pt-BR');
                const description = `"${(txn.description || '').replace(/"/g, '""')}"`;
                const categoryName = allCategories[txn.category]?.name || txn.category;
                const category = `"${categoryName}"`;
                const type = txn.type === 'receita' ? 'Receita' : 'Despesa';
                const value = txn.value.toFixed(2).replace('.', ',');
                const status = txn.status === 'confirmada' ? 'Confirmada' : 
                              txn.status === 'pendente' ? 'Pendente' : 'Cancelada';
                
                return [date, description, category, type, value, status].join(';');
            });
            
            // Combine headers and rows
            const csvContent = [headers.join(';'), ...rows].join('\n');
            
            // Add BOM for Excel UTF-8 support
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create download link
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `financeiro_export_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logger.log('üì• CSV exportado com sucesso:', state.transactions.length, 'transa√ß√µes');
        }

        function printReport() {
            // Ensure all data is visible before printing
            if (state.transactions.length === 0) {
                alert('N√£o h√° dados para imprimir.');
                return;
            }
            
            // Update print header with user info and date
            const printDate = document.getElementById('print-date');
            const printUserName = document.getElementById('print-user-name');
            const printUserEmail = document.getElementById('print-user-email');
            
            if (printDate) {
                const now = new Date();
                printDate.textContent = `Gerado em ${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR')}`;
            }
            
            if (state.user) {
                if (printUserName) printUserName.textContent = state.user.name || 'Usu√°rio';
                if (printUserEmail) printUserEmail.textContent = state.user.email || '';
            }
            
            logger.log('üñ®Ô∏è Preparando impress√£o...');
            window.print();
        }

        // Transaction form submission
        ui.elements.formTransaction.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const type = formData.get('type');
            const description = document.getElementById('txn-description').value.trim();
            const value = parseFloat(document.getElementById('txn-value').value);
            const category = document.getElementById('txn-category').value;
            const dateInput = document.getElementById('txn-date').value;
            const status = document.getElementById('txn-status').value;
            const isRecurring = ui.elements.txnRecurring.checked;
            const recurringMonths = parseInt(ui.elements.txnRecurringMonths.value) || 12;
            
            // Payment method and credit card data
            const paymentMethod = ui.elements.txnPaymentMethod.value;
            const cardId = paymentMethod === 'credit' ? ui.elements.txnCard.value : null;
            const installments = paymentMethod === 'credit' ? parseInt(ui.elements.txnInstallments.value) : 1;
            
            // Convert date string to timestamp
            const date = new Date(dateInput).getTime();
            
            // Validate credit card selection
            if (paymentMethod === 'credit' && !cardId) {
                ui.showModalMessage('Selecione um cart√£o de cr√©dito.', 'error');
                return;
            }
            
            try {
                ui.setLoading(true);
                ui.elements.modalMessage.classList.add('hidden');
                
                // Use saveTransaction with edit mode detection
                const transactionId = state.editingTransaction ? state.editingTransaction.id : null;
                await saveTransaction({
                    type,
                    description,
                    value,
                    category,
                    date,
                    status,
                    paymentMethod,
                    cardId,
                    installments
                }, transactionId, isRecurring, recurringMonths);
                
                // Success
                ui.hideTransactionModal();
                ui.setLoading(false);
                state.editingTransaction = null; // Clear edit mode
                
            } catch (error) {
                ui.showModalMessage(error.message, 'error');
                ui.setLoading(false);
            }
        });

        // ============================================
        // CREDIT CARDS MANAGEMENT
        // ============================================

        /**
         * Render credit cards list
         */
        function renderCards() {
            const container = ui.elements.cardsContainer;
            if (!container) return;
            
            if (state.cards.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full">
                        <button 
                            onclick="openCardModal()"
                            class="w-full p-12 border-2 border-dashed border-slate-300 bg-slate-50 rounded-2xl hover:bg-slate-100 hover:border-slate-400 transition-all group cursor-pointer"
                        >
                            <div class="flex flex-col items-center justify-center space-y-3">
                                <div class="w-16 h-16 rounded-full bg-slate-200 group-hover:bg-blue-100 flex items-center justify-center transition-all">
                                    <i class="fas fa-plus text-slate-400 group-hover:text-blue-600 text-2xl transition-all"></i>
                                </div>
                                <div class="text-center">
                                    <p class="text-slate-600 font-semibold group-hover:text-slate-800 transition-all">Cadastrar Novo Cart√£o</p>
                                    <p class="text-xs text-slate-400 mt-1">Clique aqui para adicionar seu primeiro cart√£o de cr√©dito</p>
                                </div>
                            </div>
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.cards.map(card => {
                const brandIcon = card.brand === 'mastercard' ? 'fa-cc-mastercard' :
                                 card.brand === 'visa' ? 'fa-cc-visa' : 'fa-credit-card';
                
                // FASE 14: Get real invoice data for current month
                const now = new Date();
                const invoiceData = getInvoiceData(card, now.getMonth(), now.getFullYear());
                const faturaAtual = invoiceData.total;
                
                // Calculate total used limit (all future installments)
                const cardTransactions = state.transactions.filter(t => 
                    t.cardId === card.id && 
                    (t.status === 'pendente' || t.status === 'confirmada')
                );
                const limiteUsado = cardTransactions.reduce((sum, t) => sum + (t.value || 0), 0);
                const disponivel = card.limit - limiteUsado;
                
                return `
                    <div class="group relative rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 cursor-pointer" 
                         style="background: linear-gradient(135deg, ${card.color} 0%, ${card.color}DD 100%);"
                         onclick="navigateToCardsView()">
                        
                        <!-- Card Header -->
                        <div class="flex items-start justify-between mb-8">
                            <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center">
                                <i class="fas fa-microchip text-white text-xl"></i>
                            </div>
                            <i class="fab ${brandIcon} text-white text-3xl opacity-90"></i>
                        </div>
                        
                        <!-- Card Info -->
                        <div class="space-y-2">
                            <h4 class="text-white text-xl font-bold tracking-wide">${card.name}</h4>
                            <p class="text-white/80 text-sm">Fatura Atual: ${formatCurrency(faturaAtual)}</p>
                            <p class="text-white/70 text-xs">
                                <i class="fas fa-calendar mr-1"></i>Vence dia ${card.dueDay}
                            </p>
                            <p class="text-white/70 text-xs">
                                <i class="fas fa-coins mr-1"></i>Dispon√≠vel: ${formatCurrency(disponivel)}
                            </p>
                        </div>
                        
                        <!-- Edit & Delete Buttons (appear on hover) -->
                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                            <button 
                                onclick="event.stopPropagation(); openCardForEdit('${card.id}')" 
                                class="w-8 h-8 bg-white/20 hover:bg-blue-500 backdrop-blur-sm rounded-lg transition-all flex items-center justify-center"
                                title="Editar cart√£o"
                            >
                                <i class="fas fa-pencil-alt text-white text-xs"></i>
                            </button>
                            <button 
                                onclick="event.stopPropagation(); deleteCard('${card.id}')" 
                                class="w-8 h-8 bg-white/20 hover:bg-red-500 backdrop-blur-sm rounded-lg transition-all flex items-center justify-center"
                                title="Excluir cart√£o"
                            >
                                <i class="fas fa-trash-alt text-white text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * FASE 14: Render cards management view (Master-Detail Invoice Management)
         */
        /**
         * FASE 14.7: Navigate to previous month (Cards view)
         */
        ui.prevCardMonth = function() {
            const date = new Date(state.cardDate);
            date.setMonth(date.getMonth() - 1);
            state.cardDate = date;
            
            // Update selected invoice to match
            state.selectedInvoice.month = date.getMonth();
            state.selectedInvoice.year = date.getFullYear();
            
            this.renderCardsView();
        };

        /**
         * FASE 14.7: Navigate to next month (Cards view)
         */
        ui.nextCardMonth = function() {
            const date = new Date(state.cardDate);
            date.setMonth(date.getMonth() + 1);
            state.cardDate = date;
            
            // Update selected invoice to match
            state.selectedInvoice.month = date.getMonth();
            state.selectedInvoice.year = date.getFullYear();
            
            this.renderCardsView();
        };

        /**
         * FASE 14.7: Reset to current month (Cards view)
         */
        ui.resetCardMonth = function() {
            state.cardDate = new Date();
            
            // Update selected invoice to match
            state.selectedInvoice.month = state.cardDate.getMonth();
            state.selectedInvoice.year = state.cardDate.getFullYear();
            
            this.renderCardsView();
        };

        ui.renderCardsView = function() {
            const masterDetail = ui.elements.cardsMasterDetail;
            const emptyState = ui.elements.cardsEmptyState;
            
            if (!masterDetail || !emptyState) return;
            
            // FASE 14.7: Update period display
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const displayMonth = monthNames[state.cardDate.getMonth()];
            const displayYear = state.cardDate.getFullYear();
            
            if (ui.elements.cardPeriodDisplay) {
                ui.elements.cardPeriodDisplay.textContent = `${displayMonth} ${displayYear}`;
            }
            
            // FASE 14.7: Show/hide reset button
            const now = new Date();
            const isCurrentMonth = state.cardDate.getMonth() === now.getMonth() && 
                                  state.cardDate.getFullYear() === now.getFullYear();
            
            if (ui.elements.btnResetCardMonth) {
                ui.elements.btnResetCardMonth.classList.toggle('hidden', isCurrentMonth);
            }
            
            // Show/hide empty state
            if (state.cards.length === 0) {
                masterDetail.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            masterDetail.classList.remove('hidden');
            
            // If no card is selected, select the first one
            if (!state.selectedInvoice.cardId && state.cards.length > 0) {
                state.selectedInvoice.cardId = state.cards[0].id;
                // FASE 14.7: Use cardDate instead of 'now'
                state.selectedInvoice.month = state.cardDate.getMonth();
                state.selectedInvoice.year = state.cardDate.getFullYear();
            }
            
            // Render card selector
            this.renderCardSelector();
            
            // Render invoice details
            this.renderInvoiceDetails();
        };

        /**
         * FASE 14: Render card selector (master list)
         */
        ui.renderCardSelector = function() {
            const container = ui.elements.cardsSelectorList;
            if (!container) return;
            
            container.innerHTML = state.cards.map(card => {
                const isSelected = state.selectedInvoice.cardId === card.id;
                const brandIcon = card.brand === 'mastercard' ? 'fa-cc-mastercard' :
                                 card.brand === 'visa' ? 'fa-cc-visa' : 'fa-credit-card';
                
                return `
                    <button 
                        onclick="selectCard('${card.id}')"
                        class="w-full text-left p-4 rounded-xl transition-all ${
                            isSelected 
                                ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-500' 
                                : 'bg-slate-50 hover:bg-slate-100 border-2 border-transparent'
                        }"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-slate-800">${card.name}</span>
                            <i class="fab ${brandIcon} text-lg ${isSelected ? 'text-blue-600' : 'text-slate-400'}"></i>
                        </div>
                        <div class="flex items-center justify-between text-xs text-slate-600">
                            <span>Limite: ${formatCurrency(card.limit)}</span>
                        </div>
                    </button>
                `;
            }).join('');
        };

        /**
         * FASE 14: Render invoice details
         */
        ui.renderInvoiceDetails = function() {
            const card = state.cards.find(c => c.id === state.selectedInvoice.cardId);
            if (!card) return;
            
            const { month, year } = state.selectedInvoice;
            const invoiceData = getInvoiceData(card, month, year);
            
            // Render invoice summary
            this.renderInvoiceSummary(card, invoiceData);
            
            // Render invoice transactions
            this.renderInvoiceTransactions(invoiceData);
        };

        /**
         * FASE 14: Render invoice summary panel
         */
        ui.renderInvoiceSummary = function(card, invoiceData) {
            const panel = ui.elements.invoiceSummaryPanel;
            if (!panel) return;
            
            const statusConfig = {
                open: { label: 'Aberta', color: 'blue', icon: 'fa-folder-open' },
                closed: { label: 'Fechada', color: 'orange', icon: 'fa-folder' },
                paid: { label: 'Paga', color: 'green', icon: 'fa-check-circle' }
            };
            
            const status = statusConfig[invoiceData.status];
            const dueDateStr = invoiceData.dueDate.toLocaleDateString('pt-BR');
            
            panel.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-1">${formatCurrency(invoiceData.total)}</h2>
                        <p class="text-sm text-slate-500">Total da Fatura</p>
                    </div>
                    <div class="text-right">
                        <div class="inline-flex items-center px-3 py-1.5 rounded-full bg-${status.color}-100 border border-${status.color}-200 mb-2">
                            <i class="fas ${status.icon} text-${status.color}-600 mr-2"></i>
                            <span class="text-sm font-semibold text-${status.color}-700">${status.label}</span>
                        </div>
                        <p class="text-xs text-slate-500">Vence em ${dueDateStr}</p>
                    </div>
                </div>
                
                ${invoiceData.status === 'closed' && invoiceData.total > 0 ? `
                    <button 
                        onclick="payInvoice('${card.id}', ${state.selectedInvoice.month}, ${state.selectedInvoice.year})"
                        class="w-full px-6 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                    >
                        <i class="fas fa-money-bill-wave mr-2"></i>üí∏ Pagar Fatura de ${formatCurrency(invoiceData.total)}
                    </button>
                ` : ''}
                
                ${invoiceData.status === 'paid' ? `
                    <div class="space-y-3">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-emerald-600 text-xl mr-3"></i>
                                    <div>
                                        <p class="text-sm font-semibold text-emerald-800">Fatura Paga</p>
                                        <p class="text-xs text-emerald-600">Pago em ${new Date(invoiceData.paidAt).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                                <button 
                                    onclick="restoreInvoice('${card.id}', ${state.selectedInvoice.month}, ${state.selectedInvoice.year})"
                                    class="px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 rounded-lg transition-all text-sm font-medium"
                                    title="Desfazer pagamento"
                                >
                                    <i class="fas fa-undo mr-2"></i>Restaurar
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        };

        /**
         * FASE 14.6: Render invoice transactions list
         */
        ui.renderInvoiceTransactions = function(invoiceData) {
            const container = ui.elements.invoiceTransactionsList;
            if (!container) return;
            
            const card = state.cards.find(c => c.id === state.selectedInvoice.cardId);
            if (!card) return;
            
            // Render add button in header (only if invoice is not paid)
            const headerButton = document.getElementById('invoice-add-button-header');
            if (headerButton) {
                if (invoiceData.status !== 'paid') {
                    headerButton.innerHTML = `
                        <button 
                            onclick="openCardExpense('${card.id}')"
                            class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-all flex items-center gap-1.5 shadow-sm hover:shadow"
                            title="Adicionar compra neste cart√£o"
                        >
                            <i class="fas fa-plus"></i>
                            <span>Adicionar</span>
                        </button>
                    `;
                } else {
                    headerButton.innerHTML = '';
                }
            }
            
            if (invoiceData.transactions.length === 0) {
                container.innerHTML = `
                    <div class="py-16 text-center">
                        <div class="inline-block p-6 bg-blue-50 rounded-full mb-4">
                            <i class="fas fa-shopping-bag text-blue-300 text-5xl"></i>
                        </div>
                        <p class="text-slate-600 font-medium mb-6">Fatura vazia</p>
                        ${invoiceData.status !== 'paid' ? `
                            <button 
                                onclick="openCardExpense('${card.id}')"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all"
                            >
                                <i class="fas fa-plus-circle text-lg"></i>
                                <span>Adicionar primeira compra</span>
                            </button>
                        ` : '<p class="text-slate-400 text-sm">Esta fatura foi paga sem compras registradas</p>'}
                    </div>
                `;
                return;
            }
            
            // Sort by purchase date (most recent first)
            const sorted = [...invoiceData.transactions].sort((a, b) => b.purchaseDate - a.purchaseDate);
            
            container.innerHTML = `
                <div class="space-y-3">
                    ${sorted.map(t => {
                        const purchaseDate = new Date(t.purchaseDate).toLocaleDateString('pt-BR');
                        const installmentText = t.installment ? 
                            `${t.installment.current}/${t.installment.total}x` : '';
                        
                        return `
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all">
                                <div class="flex-1">
                                    <p class="font-semibold text-slate-800">${t.description}</p>
                                    <p class="text-xs text-slate-500 mt-1">
                                        <i class="fas fa-calendar mr-1"></i>${purchaseDate}
                                        ${installmentText ? `<span class="ml-3"><i class="fas fa-credit-card mr-1"></i>${installmentText}</span>` : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-slate-800">${formatCurrency(t.value)}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        /**
         * Open card modal for creation
         */
        function openCardModal() {
            state.editingCard = null;
            
            document.getElementById('card-modal-title').textContent = 'Novo Cart√£o de Cr√©dito';
            ui.elements.formCard.reset();
            
            // Set default color
            document.getElementById('card-color').value = '#820AD1';
            
            // Reset color selector visual
            document.querySelectorAll('.color-selector div').forEach(div => div.classList.add('hidden'));
            document.querySelector('.color-selector[data-color="#820AD1"] div').classList.remove('hidden');
            
            ui.elements.cardModalMessage.classList.add('hidden');
            ui.elements.modalCard.classList.remove('hidden');
            
            document.getElementById('card-name').focus();
        }

        /**
         * Open card for editing
         */
        window.openCardForEdit = function(cardId) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            state.editingCard = card;
            
            document.getElementById('card-modal-title').textContent = 'Editar Cart√£o';
            
            // Fill form
            document.getElementById('card-name').value = card.name;
            document.getElementById('card-limit').value = card.limit;
            document.getElementById('card-closing-day').value = card.closingDay;
            document.getElementById('card-due-day').value = card.dueDay;
            document.getElementById('card-color').value = card.color;
            
            // Set brand radio
            const brandRadio = document.querySelector(`input[name="card-brand"][value="${card.brand}"]`);
            if (brandRadio) brandRadio.checked = true;
            
            // Update color selector visual
            document.querySelectorAll('.color-selector div').forEach(div => div.classList.add('hidden'));
            const selectedColor = document.querySelector(`.color-selector[data-color="${card.color}"] div`);
            if (selectedColor) selectedColor.classList.remove('hidden');
            
            ui.elements.modalCard.classList.remove('hidden');
        };

        /**
         * Save card (create or update)
         */
        async function saveCard(cardData, cardId = null) {
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                // Validate data
                if (!cardData.name || cardData.name.length > 30) {
                    throw new Error('Nome inv√°lido (m√°x. 30 caracteres).');
                }
                
                if (!cardData.limit || cardData.limit <= 0) {
                    throw new Error('Limite deve ser maior que zero.');
                }
                
                if (!cardData.closingDay || cardData.closingDay < 1 || cardData.closingDay > 31) {
                    throw new Error('Dia de fechamento inv√°lido (1-31).');
                }
                
                if (!cardData.dueDay || cardData.dueDay < 1 || cardData.dueDay > 31) {
                    throw new Error('Dia de vencimento inv√°lido (1-31).');
                }
                
                const cardsRef = ref(database, `users/${auth.currentUser.uid}/cards`);
                
                if (cardId) {
                    // UPDATE MODE
                    const cardRef = ref(database, `users/${auth.currentUser.uid}/cards/${cardId}`);
                    await update(cardRef, cardData);
                    logger.log('‚úÖ Cart√£o atualizado:', cardId);
                } else {
                    // CREATE MODE
                    const newCard = {
                        ...cardData,
                        createdAt: Date.now()
                    };
                    await push(cardsRef, newCard);
                    logger.log('‚úÖ Cart√£o criado');
                }
                
            } catch (error) {
                logger.error('‚ùå Erro ao salvar cart√£o:', error);
                throw error;
            }
        }

        /**
         * Delete a card
         */
        window.deleteCard = async function(cardId) {
            if (!confirm('Deseja realmente excluir este cart√£o?')) {
                return;
            }
            
            try {
                if (!auth.currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                const cardRef = ref(database, `users/${auth.currentUser.uid}/cards/${cardId}`);
                await set(cardRef, null);
                
                logger.log('‚úÖ Cart√£o exclu√≠do:', cardId);
                
            } catch (error) {
                logger.error('‚ùå Erro ao excluir cart√£o:', error);
                alert(error.message || 'Erro ao excluir cart√£o.');
            }
        };

        /**
         * Setup Firebase listener for cards
         */
        function setupCardListener(userId) {
            if (listeners.cards) {
                listeners.cards(); // Unsubscribe previous listener
            }
            
            const cardsRef = ref(database, `users/${userId}/cards`);
            
            listeners.cards = onValue(cardsRef, (snapshot) => {
                const cardsData = snapshot.val();
                
                if (cardsData) {
                    state.cards = Object.keys(cardsData).map(key => ({
                        id: key,
                        ...cardsData[key]
                    }));
                } else {
                    state.cards = [];
                }
                
                logger.log('üí≥ Cart√µes carregados:', state.cards.length);
                renderCards();
                
                // Also update cards view if currently active
                if (state.currentView === 'cards') {
                    ui.renderCardsView();
                }
            });
        }

        /**
         * FASE 14: Setup Invoice Listener
         * Listen for paid invoice records
         */
        function setupInvoiceListener(userId) {
            if (listeners.invoices) {
                listeners.invoices(); // Unsubscribe previous listener
            }
            
            const invoicesRef = ref(database, `users/${userId}/invoices`);
            
            listeners.invoices = onValue(invoicesRef, (snapshot) => {
                const invoicesData = snapshot.val();
                
                if (invoicesData) {
                    state.invoices = invoicesData;
                } else {
                    state.invoices = {};
                }
                
                logger.log('üìã Faturas carregadas:', Object.keys(state.invoices).length);
                
                // Update cards view if currently active
                if (state.currentView === 'cards') {
                    ui.renderCardsView();
                }
                
                // Update dashboard widgets
                renderCards();
            });

            // FASE 19: Listen to backups
            const backupsRef = ref(database, `users/${userId}/backups`);
            
            listeners.backups = onValue(backupsRef, (snapshot) => {
                const backupsData = snapshot.val();
                
                if (backupsData) {
                    state.backups = backupsData;
                } else {
                    state.backups = {};
                }
                
                logger.log('üíæ Backups carregados:', Object.keys(state.backups).length);
                
                // Update backup list if settings modal is open
                if (!ui.elements.modalSettings.classList.contains('hidden')) {
                    renderBackupList();
                }
            });

            // FASE 19: Initialize theme
            initializeTheme();
        }

        // Navigation controls
        ui.elements.btnViewCards.addEventListener('click', () => {
            ui.showView('cards');
        });

        ui.elements.btnViewDashboard.addEventListener('click', () => {
            ui.showView('dashboard');
        });

        ui.elements.btnDashboardFromCards.addEventListener('click', () => {
            ui.showView('dashboard');
        });

        // Card modal controls
        ui.elements.btnNewCard.addEventListener('click', () => {
            openCardModal();
        });

        ui.elements.btnAddCard.addEventListener('click', () => {
            openCardModal();
        });

        ui.elements.btnAddCardEmpty.addEventListener('click', () => {
            openCardModal();
        });

        ui.elements.btnCloseCardModal.addEventListener('click', () => {
            ui.elements.modalCard.classList.add('hidden');
        });

        ui.elements.btnCancelCard.addEventListener('click', () => {
            ui.elements.modalCard.classList.add('hidden');
        });

        // Close card modal on background click
        ui.elements.modalCard.addEventListener('click', (e) => {
            if (e.target === ui.elements.modalCard) {
                ui.elements.modalCard.classList.add('hidden');
            }
        });

        // Color selector logic
        document.querySelectorAll('.color-selector').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const color = e.currentTarget.dataset.color;
                
                // Update hidden input
                document.getElementById('card-color').value = color;
                
                // Update visual selection
                document.querySelectorAll('.color-selector div').forEach(div => div.classList.add('hidden'));
                e.currentTarget.querySelector('div').classList.remove('hidden');
            });
        });

        // Card form submission
        ui.elements.formCard.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('card-name').value.trim();
            const limit = parseFloat(document.getElementById('card-limit').value);
            const closingDay = parseInt(document.getElementById('card-closing-day').value);
            const dueDay = parseInt(document.getElementById('card-due-day').value);
            const color = document.getElementById('card-color').value;
            const formData = new FormData(e.target);
            const brand = formData.get('card-brand');
            
            try {
                ui.setLoading(true);
                ui.elements.cardModalMessage.classList.add('hidden');
                
                const cardId = state.editingCard ? state.editingCard.id : null;
                await saveCard({
                    name,
                    limit,
                    closingDay,
                    dueDay,
                    color,
                    brand
                }, cardId);
                
                // Success
                ui.elements.modalCard.classList.add('hidden');
                ui.setLoading(false);
                state.editingCard = null;
                
            } catch (error) {
                ui.elements.cardModalMessage.classList.remove('hidden');
                ui.elements.cardModalMessage.classList.add('bg-red-50', 'text-red-700');
                ui.elements.cardModalMessageText.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${error.message}`;
                ui.setLoading(false);
            }
        });

        // ============================================
        // AUTHENTICATION STATE OBSERVER (The Heart of the App)
        // ============================================
        
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    // ‚úÖ User is signed in
                    logger.log('üîê Autentica√ß√£o detectada:', user.uid);
                    
                    // Show loading while fetching user data
                    ui.setLoading(true);
                    
                    // Fetch user data from Realtime Database
                    const userRef = ref(database, `users/${user.uid}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        
                        // Combine Auth + Database data into state
                        state.user = {
                            uid: user.uid,
                            email: user.email,
                            emailVerified: user.emailVerified,
                            name: userData.name || user.email.split('@')[0],
                            createdAt: userData.createdAt,
                            settings: userData.settings || {
                                theme: 'light',
                                currency: 'BRL',
                                notifications: true
                            }
                        };
                        
                        logger.log('‚úÖ Dados do usu√°rio carregados:', state.user.name);
                        
                        // Update UI with user profile
                        ui.updateUserProfile({
                            displayName: state.user.name,
                            email: state.user.email
                        });
                        
                    } else {
                        // User exists in Auth but not in Database (edge case)
                        logger.warn('‚ö†Ô∏è Usu√°rio n√£o encontrado no database. Criando perfil...');
                        
                        // Create minimal profile
                        const newUserData = {
                            name: user.email.split('@')[0],
                            email: user.email,
                            createdAt: Date.now(),
                            settings: {
                                theme: 'light',
                                currency: 'BRL',
                                notifications: true
                            }
                        };
                        
                        await set(userRef, newUserData);
                        
                        state.user = {
                            uid: user.uid,
                            email: user.email,
                            emailVerified: user.emailVerified,
                            ...newUserData
                        };
                        
                        ui.updateUserProfile({
                            displayName: state.user.name,
                            email: state.user.email
                        });
                    }
                    
                    // Update current date in header
                    ui.updateCurrentDate();
                    ui.updateMonthDisplay();
                    
                    // Setup real-time listeners
                    setupTransactionListener();
                    setupCategoryListener();
                    setupBudgetListener(user.uid);
                    setupCardListener(user.uid);
                    setupInvoiceListener(user.uid);
                    
                    // Transition to dashboard
                    ui.showView('dashboard');
                    ui.setLoading(false);
                    
                    logger.log('üéâ Login completo. Dashboard carregado.');
                    
                } else {
                    // ‚ùå User is signed out
                    console.log('üö™ Usu√°rio deslogado');
                    
                    // Clean up all listeners
                    if (listeners.transactions) {
                        listeners.transactions();
                        listeners.transactions = null;
                    }
                    if (listeners.categories) {
                        listeners.categories();
                        listeners.categories = null;
                    }
                    if (listeners.budgets) {
                        listeners.budgets();
                        listeners.budgets = null;
                    }
                    if (listeners.cards) {
                        listeners.cards();
                        listeners.cards = null;
                    }
                    if (listeners.invoices) {
                        listeners.invoices();
                        listeners.invoices = null;
                    }
                    
                    // Clear state
                    state.user = null;
                    state.transactions = [];
                    state.categories = {};
                    state.budgets = {};
                    state.cards = [];
                    state.invoices = {};
                    
                    // Reset UI to login view
                    ui.showView('login');
                    ui.setLoading(false);
                    
                    // Clear any error messages
                    ui.elements.authMessage.classList.add('hidden');
                }
            } catch (error) {
                logger.error('‚ùå Erro no observador de autentica√ß√£o:', error);
                
                // Show error and return to login
                ui.setLoading(false);
                ui.showView('login');
                ui.showAuthMessage('Erro ao carregar dados do usu√°rio. Tente fazer login novamente.', 'error');
                
                // Logout to reset state
                if (auth.currentUser) {
                    await signOut(auth);
                }
            }
        });

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        /**
         * Format currency to BRL
         * @param {number} value - Numeric value
         * @returns {string} Formatted currency
         */
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        /**
         * Format date to readable string
         * @param {number} timestamp - Unix timestamp
         * @returns {string} Formatted date
         */
        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // ============================================
        // GLOBAL FUNCTION EXPOSURE
        // ============================================
        
        // FASE 19.2: Expor fun√ß√µes necess√°rias para onclick inline
        window.openCardModal = openCardModal;

        // ============================================
        // INITIALIZATION
        // ============================================
        
        logger.log('üöÄ App inicializado');
        logger.log('üìä Firebase conectado');
        
        // Initial view
        ui.setLoading(true);
        
    </script>

</body>
</html>